# Вариант docker-compose для локального тестирования
# Использование: docker compose -f docker-compose.local.yml up --build

services:
  node-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: remnawave-node-agent-local
    restart: unless-stopped

    env_file:
      - .env

    # Для локального тестирования монтируем тестовые логи
    volumes:
      - ./test-logs:/var/log/remnanode:ro

    # Подключаемся к Admin Bot через host.docker.internal
    # В .env должно быть: AGENT_COLLECTOR_URL=http://host.docker.internal:8000
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Healthcheck
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'python -m src.main' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    stop_grace_period: 15s

    # Логирование
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
