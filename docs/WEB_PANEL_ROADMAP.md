# Web Panel — Roadmap v2

План развития веб-панели Remnawave Admin.

---

## Текущее состояние

Веб-панель представляет собой полнофункциональную систему управления VPN-инфраструктурой. Ниже — сводка всего, что реализовано на данный момент.

**Стек:** React 18, TypeScript, Vite, Tailwind CSS, shadcn/ui (Radix UI), React Query, Zustand, Recharts, Leaflet, Axios, Sonner, cmdk

### Инфраструктура UI

- Дизайн-система на shadcn/ui: 17+ компонентов (Button, Card, Dialog, Table, Select, Badge, Tabs, Tooltip, DropdownMenu и др.)
- Тёмная тема с CSS-переменными (teal/cyan акценты), единая цветовая схема
- Иконки: lucide-react
- Адаптивный дизайн: desktop-таблицы + мобильные карточки на всех страницах
- Skeleton-загрузки, toast-уведомления (sonner), ConfirmDialog
- Command Palette (Cmd/Ctrl+K): навигация, быстрые действия, live-поиск пользователей
- Breadcrumbs с динамическим разрешением имён
- Сохранённые фильтры (Zustand + localStorage)

### Страницы и функции

| Страница | Функциональность |
|----------|-----------------|
| **Dashboard** | Карточки статистики с дельта-индикаторами, графики трафика (stacked area chart по нодам, переключатель 24ч/7д/30д), парк серверов (компактные карточки с быстрыми действиями), системный статус (API, PostgreSQL, ноды, WebSocket), проверка обновлений (GitHub Releases API) |
| **Users** | CRUD с пагинацией/фильтрацией/сортировкой, массовые операции (чекбоксы, enable/disable/delete/reset-traffic, до 100 за раз), экспорт CSV/JSON |
| **User Detail** | Трафик, HWID устройства, нарушения, история действий админов (timeline) |
| **Nodes** | CRUD, статус, перезапуск Xray, агент-токены (генерация/отзыв/статус), enable/disable |
| **Fleet** | Мониторинг парка нод: CPU, RAM, диск, скорость DL/UL, uptime, Xray-версия, пользователи онлайн |
| **Hosts** | CRUD, inbound конфигурация, security layer (TLS, Reality, XTLS), SNI/host/path, порты, позиционирование |
| **Violations** | Просмотр нарушений с IP Lookup и скор-разбивкой (temporal, geo, ASN, profile, device), фильтры по IP/стране/дате, resolve-действия, экспорт CSV/JSON |
| **Automations** | Конструктор правил (4-шаговый визард), 3 типа триггеров (событие/расписание/порог), 7 типов действий, 6 готовых шаблонов, лог срабатываний, dry-run тестирование, CRON-билдер |
| **Analytics** | Географическая карта подключений (Leaflet), топ пользователей по трафику, анализ тенденций (area chart) |
| **Admins** | CRUD админов, конструктор ролей (матрица прав 9 ресурсов × 5 действий), прогресс-бары лимитов, журнал аудита |
| **Audit Log** | Автоматическое логирование всех мутаций (middleware), фильтры по админу/ресурсу/периоду, экспорт, real-time через WebSocket |
| **System Logs** | Real-time стриминг логов через WebSocket, 4 источника (web/bot × INFO/WARNING), фильтр по уровню и тексту, live/paused режим |
| **Settings** | Динамические настройки (3-tier: DB > .env > defaults), категории, маскировка секретов, IP whitelist, статус синхронизации |
| **Login** | Telegram Login Widget + логин/пароль, JWT (access + refresh), определение первого запуска (форма регистрации первого админа) |

### Системные возможности

- **RBAC**: 4 системные роли (superadmin, manager, operator, viewer), PermissionGate на всех страницах, квоты для админов
- **WebSocket**: real-time обновления (ноды, пользователи, нарушения, аудит), автоматическая инвалидация React Query кеша, toast-уведомления о действиях других админов
- **Движок автоматизаций**: обработка событий, CRON/interval планировщик (60с цикл), мониторинг порогов (5-мин цикл), lock на повторное срабатывание (30с), интеграция с WebSocket
- **Аудит**: AuditMiddleware перехватывает все POST/PUT/PATCH/DELETE, broadcast через WebSocket
- **Проверка обновлений**: GitHub Releases API с 30-мин кешем, семантическое сравнение версий

### База данных (16 миграций Alembic)

Основные таблицы: `users`, `nodes`, `hosts`, `violations`, `ip_metadata`, `hwid_devices`, `bot_config`, `admin_roles`, `admin_permissions`, `admin_accounts`, `admin_audit_log`, `automation_rules`, `automation_log`, `node_agent_tokens`

### Backend API (14 модулей маршрутов)

`auth`, `users`, `nodes`, `hosts`, `violations`, `analytics`, `advanced_analytics`, `automations`, `settings`, `admins`, `roles`, `audit`, `logs`, `websocket`

---

## Выполненные фазы (архив)

| Фаза | Название | Описание |
|------|----------|----------|
| 1 | Миграция на shadcn/ui | Все страницы + Layout мигрированы. Единая дизайн-система, CSS-переменные, lucide-react |
| 2 | RBAC | 4 роли, матрица прав, CRUD админов и ролей, квоты, Permission-aware UI, совместимость с legacy auth |
| 3 | Улучшение Dashboard | Графики трафика, дельта-индикаторы, карточки нод с быстрыми действиями, системный статус |
| 4 | Улучшение функций | Массовые операции, экспорт CSV/JSON, Command Palette, сохранённые фильтры, toast/ConfirmDialog/breadcrumbs |
| 5 | Новые функции | Аудит-лог с middleware, системные логи, проверка обновлений, расширенная аналитика (гео + тренды), реалтайм-уведомления |
| 6 | Автоматизации | Конструктор правил, 3 типа триггеров, 7 действий, 6 шаблонов, движок с CRON/threshold/event, dry-run |

---

## Фаза 7 — Визард первого запуска и компоненты системы

**Зачем:** Сейчас при первом запуске есть только форма создания первого админа. Полноценный визард проведёт по всем шагам настройки, а страница «Компоненты» даст единую точку мониторинга и управления всеми частями системы.

**Текущее состояние:** Реализовано определение первого запуска (`GET /auth/setup-status`) и регистрация первого админа на странице Login. Многошагового визарда и страницы компонентов нет.

### 7.1 Визард первого запуска (Setup Wizard)

При первом входе в панель (если нет админов) — пошаговый визард вместо простой формы регистрации:

| Шаг | Что делает |
|-----|-----------|
| 1. Приветствие | Описание системы, что будет настроено |
| 2. Подключение к API | Ввод API_BASE_URL и API_TOKEN, кнопка «Проверить соединение» |
| 3. Настройка бота | BOT_TOKEN, проверка что бот отвечает |
| 4. Создание админа | Имя, пароль, привязка Telegram (опционально). Уже реализовано — интегрировать в визард |
| 5. Webhook (опционально) | Включить/выключить, WEBHOOK_SECRET, тест |
| 6. Anti-Abuse (опционально) | Включить/выключить, базовые пороги |
| 7. Готово | Сводка настроек, кнопка «Перейти в панель» |

### 7.2 Страница «Компоненты системы»

Выделенная страница с карточками всех компонентов:

| Компонент | Статус | Метрики | Действия |
|-----------|--------|---------|----------|
| Telegram Bot | Online/Offline | Uptime, команд обработано | Перезапуск, логи |
| Web Backend | Online/Offline | Uptime, запросов/мин, активные сессии | Логи |
| PostgreSQL | Connected/Error | Размер БД, кол-во записей, pool usage | Бэкап, очистка |
| Remnawave API | Connected/Error | Время отклика, последняя синхронизация | Тест, синхронизация |
| Webhook Server | Active/Inactive | Принято событий, последнее событие | Тест, настройка |
| Anti-Abuse | Enabled/Disabled | Нарушений за сутки, средний скор | Настройка порогов |
| Node Agent(s) | N online / M total | Подключений за час по каждому | Токены, настройка |

### 7.3 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 7.1.1 | Backend: setup wizard API | `POST /api/v2/setup/step/{n}` — валидация и сохранение каждого шага. Проверка соединения с API, ботом, БД |
| 7.1.2 | Frontend: Setup Wizard | Многошаговая форма (Stepper) с валидацией, прогресс-баром, возможностью пропуска опциональных шагов |
| 7.1.3 | Интеграция с Login | Заменить текущую форму регистрации на полноценный визард при `needs_setup=true` |
| 7.2.1 | Backend: расширенный health | `GET /api/v2/system/components` — статус, метрики и доступные действия для каждого компонента |
| 7.2.2 | Frontend: Components page | Карточки компонентов с real-time статусом, метриками, быстрыми действиями |
| 7.2.3 | Навигация | Добавить в Sidebar (секция «Администрирование»), Command Palette, breadcrumbs |

---

## Фаза 8 — Управление подписками и тарифами

**Зачем:** Сейчас пользователи создаются вручную с указанием лимита трафика и срока. Нужна система тарифных планов, чтобы упростить управление и обеспечить единообразие.

### 8.1 Модель данных

```sql
CREATE TABLE subscription_plans (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,             -- "Базовый", "Про", "Безлимит"
    description TEXT,
    traffic_limit_gb INTEGER,               -- NULL = безлимит
    duration_days INTEGER NOT NULL,         -- 30, 90, 365
    max_devices INTEGER DEFAULT 1,          -- лимит HWID
    speed_limit_mbps INTEGER,               -- NULL = без ограничений
    allowed_nodes UUID[],                   -- NULL = все ноды
    price DECIMAL(10,2),                    -- для отображения (фактическая оплата — вне системы)
    is_active BOOLEAN DEFAULT true,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Связь пользователя с планом
ALTER TABLE users ADD COLUMN plan_id INTEGER REFERENCES subscription_plans(id);
ALTER TABLE users ADD COLUMN plan_started_at TIMESTAMPTZ;
ALTER TABLE users ADD COLUMN plan_expires_at TIMESTAMPTZ;
```

### 8.2 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 8.1.1 | Миграция БД | Таблица `subscription_plans`, связь с `users` |
| 8.1.2 | Backend: CRUD планов | `/api/v2/plans` — список, создание, редактирование, удаление, активация/деактивация |
| 8.1.3 | Backend: назначение | При создании/редактировании пользователя — выбор плана (автозаполнение лимитов) |
| 8.1.4 | Backend: продление | `POST /api/v2/users/{uuid}/renew` — продление по текущему плану |
| 8.2.1 | Frontend: страница «Тарифы» | Карточки планов с метриками (сколько пользователей на каждом), создание/редактирование |
| 8.2.2 | Frontend: выбор плана при создании пользователя | Dropdown план → автозаполнение полей (трафик, срок, устройства) |
| 8.2.3 | Frontend: массовое продление | Выбрать пользователей → продлить на N дней или по плану |
| 8.2.4 | Dashboard: виджет подписок | Распределение по планам (pie chart), скоро истекающие подписки |

---

## Фаза 9 — Уведомления и алерты

**Зачем:** Сейчас уведомления — это toast'ы в панели и Telegram через автоматизации. Нужна полноценная подсистема уведомлений: центр уведомлений в UI, гибкая настройка каналов, эскалация.

### 9.1 Центр уведомлений (in-app)

| # | Задача | Описание |
|---|--------|----------|
| 9.1.1 | Модель данных | Таблица `notifications`: admin_id, type, title, body, is_read, link, created_at |
| 9.1.2 | Backend: API | CRUD, mark read/unread, mark all read, delete old |
| 9.1.3 | Frontend: иконка в Header | Bell с бейджем непрочитанных, dropdown с последними уведомлениями |
| 9.1.4 | Frontend: страница уведомлений | Полный список с фильтрами, группировкой по дате, массовой пометкой |
| 9.1.5 | WebSocket интеграция | Новое уведомление → push через WS → обновление бейджа + toast |

### 9.2 Каналы доставки

| # | Задача | Описание |
|---|--------|----------|
| 9.2.1 | Telegram | Отправка в личку админа / группу. Уже частично есть в автоматизациях — унифицировать |
| 9.2.2 | Webhook | POST на указанный URL с JSON payload. Шаблоны для Discord, Slack |
| 9.2.3 | Email (опционально) | SMTP настройка, HTML-шаблоны для отчётов и алертов |
| 9.2.4 | Настройка каналов на уровне админа | Каждый админ выбирает: какие события, через какой канал |

### 9.3 Правила алертов

| # | Задача | Описание |
|---|--------|----------|
| 9.3.1 | Пороговые алерты | Диск > 90%, ноды offline > N мин, трафик > X ГБ/сутки |
| 9.3.2 | Группировка и дедупликация | Не дублировать одинаковые алерты, группировать по типу |
| 9.3.3 | Эскалация | Если алерт не подтверждён за N минут → уведомить вышестоящего админа |

---

## Фаза 10 — Тестирование и стабильность

**Зачем:** Проект вырос до 14 страниц, 14 API-модулей, 16 миграций. Без тестов любое изменение может сломать существующую функциональность.

### 10.1 Frontend-тесты

| # | Задача | Описание |
|---|--------|----------|
| 10.1.1 | Настройка Vitest | vitest.config.ts, jsdom, setup файл с моками (React Query, Zustand, Axios) |
| 10.1.2 | Тесты утилит | export.ts, helpers.ts (автоматизации), форматирование байт/дат, CRON-парсер |
| 10.1.3 | Тесты хуков | useHasPermission, useWebSocket, useFiltersStore — поведение и edge cases |
| 10.1.4 | Компонентные тесты | PermissionGate, ConfirmDialog, ExportDropdown, CommandPalette — рендеринг и взаимодействие |
| 10.1.5 | Тесты страниц (smoke) | Каждая страница рендерится без ошибок с замоканными данными |

### 10.2 Backend-тесты

| # | Задача | Описание |
|---|--------|----------|
| 10.2.1 | Настройка pytest | conftest.py, фикстуры (тестовая БД, admin user, mock upstream API) |
| 10.2.2 | Тесты API | Каждый эндпоинт: happy path + ошибки + RBAC (403 для недостаточных прав) |
| 10.2.3 | Тесты RBAC | Матрица: каждая роль × каждый ресурс × каждое действие |
| 10.2.4 | Тесты автоматизаций | AutomationEngine: события, CRON, пороги, условия, блокировка повторов |
| 10.2.5 | Тесты миграций | Alembic upgrade/downgrade для всех 16 миграций |

### 10.3 E2E-тесты

| # | Задача | Описание |
|---|--------|----------|
| 10.3.1 | Настройка Playwright | playwright.config.ts, docker-compose для тестового окружения |
| 10.3.2 | Критические сценарии | Логин → создание пользователя → редактирование → удаление. Создание ноды → проверка статуса. RBAC: viewer не видит кнопку «Создать» |
| 10.3.3 | CI интеграция | GitHub Actions: lint + typecheck + unit tests + E2E на каждый PR |

---

## Фаза 11 — Мультиязычность (i18n)

**Зачем:** Панель используется не только русскоязычными админами. i18n позволит расширить аудиторию без дублирования кода.

### 11.1 Инфраструктура

| # | Задача | Описание |
|---|--------|----------|
| 11.1.1 | Настройка react-i18next | i18n.ts, языковые файлы в `locales/`, определение языка из настроек админа |
| 11.1.2 | Извлечение строк | Все hardcoded строки → `t('key')`. Namespace-разделение: common, pages/*, components/* |
| 11.1.3 | Русский (ru) | Базовый язык — перенос текущих строк |
| 11.1.4 | Английский (en) | Полный перевод |

### 11.2 Интеграция

| # | Задача | Описание |
|---|--------|----------|
| 11.2.1 | Переключатель языка | В Header или Settings, сохранение в профиле админа |
| 11.2.2 | Форматирование | Даты, числа, байты — через Intl API с учётом локали |
| 11.2.3 | Backend: i18n ошибок | Коды ошибок вместо текстовых сообщений, перевод на фронте |
| 11.2.4 | Автоматизации: шаблоны уведомлений | Шаблоны Telegram/webhook с поддержкой языка |

---

## Фаза 12 — Оптимизация производительности

**Зачем:** С ростом числа пользователей и нод таблицы становятся тяжёлыми, дашборд загружает много данных параллельно, бандл фронтенда растёт.

### 12.1 Frontend

| # | Задача | Описание |
|---|--------|----------|
| 12.1.1 | Code splitting | React.lazy + Suspense для каждой страницы. Уменьшить initial bundle |
| 12.1.2 | Виртуализация таблиц | @tanstack/react-virtual для Users/Violations (1000+ строк) |
| 12.1.3 | Оптимизация re-renders | React.memo, useMemo, useCallback для тяжёлых компонентов (графики, карта, таблицы) |
| 12.1.4 | Оптимизация Leaflet | Lazy-load карты, кластеризация маркеров (react-leaflet-cluster) при 100+ точек |
| 12.1.5 | Service Worker | Кеширование статики, offline-индикатор |

### 12.2 Backend

| # | Задача | Описание |
|---|--------|----------|
| 12.2.1 | Кеширование Redis | Результаты analytics, geo-данных, top users (TTL 1-5 мин) |
| 12.2.2 | Пагинация cursor-based | Заменить offset-пагинацию для больших таблиц (users, audit_log, automation_log) |
| 12.2.3 | Индексы БД | Аудит текущих запросов (EXPLAIN ANALYZE), добавление составных индексов |
| 12.2.4 | Сжатие WebSocket | Включить permessage-deflate для WebSocket при большом трафике данных |
| 12.2.5 | Rate limiting | Гранулярные лимиты по эндпоинтам (не только глобальный) |

---

## Фаза 13 — Бэкап, импорт и миграция

**Зачем:** Возможность экспортировать всю конфигурацию, перенести на другой сервер, восстановить после сбоя.

### 13.1 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 13.1.1 | Экспорт конфигурации | JSON-файл со всеми настройками, ролями, планами, правилами автоматизации |
| 13.1.2 | Импорт конфигурации | Загрузка JSON + валидация + применение (с диалогом конфликтов) |
| 13.1.3 | Бэкап БД из панели | Кнопка → pg_dump → скачивание архива. Расписание через автоматизации |
| 13.1.4 | Восстановление из бэкапа | Загрузка архива → pg_restore с подтверждением |
| 13.1.5 | Миграция пользователей | Импорт пользователей из CSV/JSON (массовое создание с валидацией) |
| 13.1.6 | Лог миграций | История импортов/экспортов с результатами (N успешно, M ошибок) |

---

## Фаза 14 — API для внешних интеграций

**Зачем:** Позволить внешним системам (биллинг, CRM, боты продаж, мониторинг) взаимодействовать с панелью по API без доступа к внутренним эндпоинтам.

### 14.1 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 14.1.1 | API-ключи | Генерация API-ключей для внешних систем с привязкой к роли/правам |
| 14.1.2 | Public API (v3) | Отдельный набор эндпоинтов: создание/управление пользователями, проверка статуса, получение подписки |
| 14.1.3 | Webhook-подписки | Подписка внешних систем на события (user.created, user.expired, node.offline) |
| 14.1.4 | Документация API | OpenAPI/Swagger UI с примерами, доступный из панели |
| 14.1.5 | Rate limiting для API-ключей | Индивидуальные лимиты на каждый ключ |
| 14.1.6 | SDK / примеры | Python и JavaScript клиенты, примеры интеграции с WHMCS, Telegram-ботами продаж |

---

## Приоритетность фаз

```
Выполнено:
  Фаза 1 (shadcn/ui)          ██████████  Дизайн-система                      ✅
  Фаза 2 (RBAC)               ██████████  Роли и права                        ✅
  Фаза 3 (Dashboard)          ██████████  Графики и мониторинг                ✅
  Фаза 4 (Improvements)       ██████████  Массовые операции, поиск, UX        ✅
  Фаза 5 (New features)       ██████████  Аудит, логи, аналитика              ✅
  Фаза 6 (Automations)        ██████████  Конструктор правил                  ✅

Планируется:
  Фаза 7  (Setup + Components) █████████  Визард настройки, мониторинг
  Фаза 8  (Subscriptions)      ████████   Тарифные планы
  Фаза 9  (Notifications)      ████████   Центр уведомлений, каналы
  Фаза 10 (Testing)            ███████    Unit + E2E тесты, CI
  Фаза 11 (i18n)               ██████     Мультиязычность
  Фаза 12 (Performance)        ██████     Оптимизация, кеширование
  Фаза 13 (Backup)             █████      Бэкап, импорт, миграция
  Фаза 14 (External API)       █████      API-ключи, SDK, документация
```

### Порядок реализации

1. **Фаза 7** — визард и компоненты: улучшает первый опыт и мониторинг. Фундамент для всех дальнейших настроек
2. **Фаза 8** — подписки: часто запрашиваемая функция, упрощает ежедневное управление
3. **Фаза 9** — уведомления: дополняет автоматизации и мониторинг, даёт админам контроль над каналами
4. **Фаза 10** — тестирование: к этому моменту кодовая база достаточно большая, тесты — необходимость
5. **Фаза 11** — i18n: расширение аудитории, не блокирует другие фичи
6. **Фаза 12** — производительность: оптимизация после стабилизации функциональности
7. **Фаза 13** — бэкап: важно для production, но не блокирует разработку
8. **Фаза 14** — внешний API: последняя, т.к. требует стабильного внутреннего API

Фазы 10-14 могут выполняться параллельно, т.к. затрагивают разные слои.

---

## Что НЕ планируется (и почему)

| Идея | Причина отказа |
|------|---------------|
| Система плагинов | Сторонний код, sandbox, маркетплейс — overkill. Автоматизации (Фаза 6) + внешний API (Фаза 14) закрывают эту потребность |
| Мониторинг CPU/RAM серверов | Требует системного агента на каждом сервере. Fleet уже показывает базовые метрики с Xray, для глубокого мониторинга лучше Prometheus + Grafana |
| Встроенная платёжная система | Интеграция с платёжными шлюзами — отдельный продукт. Внешний API (Фаза 14) позволит подключить любой биллинг |
| PWA / мобильное приложение | Адаптивный дизайн достаточен для мобильных. Нативное приложение не оправдывает затраты для админ-панели |

---

*Последнее обновление: Февраль 2026*
