# Web Panel — Roadmap

План развития веб-панели Remnawave Admin.

---

## Текущее состояние (v1.7)

**Реализовано:**
- Dashboard со статистикой (пользователи, ноды, нарушения, трафик)
- CRUD пользователей с фильтрацией, сортировкой, пагинацией
- Детальная карточка пользователя (трафик, HWID, нарушения)
- Управление нодами (статус, перезапуск, агент-токены)
- Управление хостами (создание, редактирование, включение/выключение)
- Просмотр нарушений с IP Lookup и скор-разбивкой
- Настройки с динамическим сохранением в БД
- Авторизация: Telegram Login Widget + логин/пароль + JWT
- WebSocket для real-time обновлений
- Тёмная тема, адаптивный дизайн

**Стек:** React 18, TypeScript, Tailwind CSS, Vite, React Query, Zustand, Recharts, Axios

---

## Фаза 1 — Миграция на shadcn/ui

**Зачем:** Сейчас весь UI написан на голом Tailwind (inline классы в страницах). shadcn/ui даёт готовую библиотеку компонентов на базе Radix UI + Tailwind с единым дизайном, доступностью (a11y) и полной кастомизацией (код копируется в проект).

**Что даст:**
- Консистентный дизайн-система (Button, Card, Dialog, Table, Select, Badge, Tabs, Input, ...)
- Встроенная доступность (клавиатурная навигация, ARIA)
- Упрощение кода страниц (вместо 20 строк Tailwind — 1 компонент)
- Единая тема с CSS-переменными (проще менять цвета)

### Задачи

| # | Задача | Описание |
|---|--------|----------|
| 1.1 | Инициализация shadcn/ui | `npx shadcn-ui@latest init` в web/frontend, настройка `components.json`, алиасы путей |
| 1.2 | Базовые компоненты | Установить: Button, Card, Badge, Input, Select, Dialog, Table, Tabs, Tooltip, Dropdown Menu, Sheet (мобильное меню), Separator, Skeleton |
| 1.3 | Рефакторинг Layout | Sidebar, Header → на shadcn Sheet/NavigationMenu, единый Layout |
| 1.4 | Рефакторинг Dashboard | Карточки статистики → Card, бейджи → Badge, кнопки → Button |
| 1.5 | Рефакторинг Users | Таблица → Table (shadcn DataTable с сортировкой), модалки → Dialog, фильтры → Select/Popover |
| 1.6 | Рефакторинг остальных страниц | Nodes, Hosts, Violations, Settings, Login — аналогичный рефакторинг |
| 1.7 | Удаление старых inline-стилей | Почистить дублирующийся Tailwind, вынести общие паттерны в компоненты |

**Зависимости:** `@radix-ui/*`, `class-variance-authority`, `clsx`, `tailwind-merge`, `lucide-react` (иконки)

**Оценка объёма:** Средний — затрагивает все 8 страниц, но каждая мигрируется независимо.

---

## Фаза 2 — Система ролей и прав администраторов (RBAC)

**Зачем:** Сейчас все админы равноправны (проверяется только `telegram_id in ADMINS`). Нужен конструктор для создания админов с разными правами и лимитами.

### 2.1 Модель данных

Новые таблицы в PostgreSQL:

```sql
-- Роли администраторов
CREATE TABLE admin_roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,        -- "superadmin", "manager", "viewer", custom
    display_name VARCHAR(200),                 -- "Супер-администратор"
    description TEXT,
    is_system BOOLEAN DEFAULT false,           -- системные роли нельзя удалить
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Права (permissions)
CREATE TABLE admin_permissions (
    id SERIAL PRIMARY KEY,
    role_id INTEGER REFERENCES admin_roles(id) ON DELETE CASCADE,
    resource VARCHAR(50) NOT NULL,             -- "users", "nodes", "hosts", "violations", "settings", "admins"
    action VARCHAR(50) NOT NULL,               -- "view", "create", "edit", "delete", "bulk_operations"
    UNIQUE(role_id, resource, action)
);

-- Администраторы с ролями и лимитами
CREATE TABLE admin_accounts (
    id SERIAL PRIMARY KEY,
    telegram_id BIGINT UNIQUE,                 -- NULL для password-only
    username VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255),
    role_id INTEGER REFERENCES admin_roles(id),

    -- Лимиты (NULL = без ограничений)
    max_users INTEGER,                         -- макс. количество создаваемых пользователей
    max_traffic_gb INTEGER,                    -- макс. суммарный трафик для его пользователей
    max_nodes INTEGER,                         -- макс. нод
    max_hosts INTEGER,                         -- макс. хостов

    -- Счётчики использования
    users_created INTEGER DEFAULT 0,
    traffic_used_bytes BIGINT DEFAULT 0,

    is_active BOOLEAN DEFAULT true,
    created_by INTEGER REFERENCES admin_accounts(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.2 Предустановленные роли

| Роль | Описание | Права |
|------|----------|-------|
| **superadmin** | Полный доступ, управление другими админами | Всё |
| **manager** | Управление пользователями, нодами, хостами | users.*, nodes.view/edit, hosts.view/edit |
| **operator** | Только просмотр + базовые действия | *.view, users.create/edit |
| **viewer** | Только просмотр | *.view |

### 2.3 Backend

| # | Задача | Описание |
|---|--------|----------|
| 2.3.1 | Миграция БД | Alembic: создать таблицы admin_roles, admin_permissions, admin_accounts |
| 2.3.2 | Middleware прав | Декоратор `@require_permission("users", "create")` для эндпоинтов |
| 2.3.3 | Проверка лимитов | Middleware: при создании пользователя проверять `users_created < max_users` |
| 2.3.4 | API: Админы | CRUD `/api/v2/admins` — список, создание, редактирование, удаление |
| 2.3.5 | API: Роли | CRUD `/api/v2/roles` — управление ролями и правами |
| 2.3.6 | Аудит действий | Логирование: кто, когда, что сделал (таблица `admin_audit_log`) |
| 2.3.7 | Миграция auth | Переход от `admin_credentials` к `admin_accounts` (обратная совместимость) |

### 2.4 Frontend — Страница «Администраторы»

| # | Задача | Описание |
|---|--------|----------|
| 2.4.1 | Список админов | Таблица: имя, роль, лимиты, использование, статус, дата создания |
| 2.4.2 | Конструктор админа | Форма создания: имя, Telegram ID (опц.), роль, лимиты (ползунки/инпуты) |
| 2.4.3 | Редактирование | Изменение роли, лимитов, включение/выключение |
| 2.4.4 | Конструктор ролей | Матрица прав: ресурс × действие (чекбоксы), название роли |
| 2.4.5 | Визуализация лимитов | Прогресс-бары: 23/50 пользователей, 450/1000 ГБ трафика |
| 2.4.6 | Permission-aware UI | Скрывать/блокировать кнопки, на которые у админа нет прав |

---

## Фаза 3 — Улучшение Dashboard

**Вдохновение:** Панель «Решала» — живые графики, карточки серверов с метриками, дельта-индикаторы.

### 3.1 Графики трафика и подключений

| # | Задача | Описание |
|---|--------|----------|
| 3.1.1 | Backend: временные ряды | Новый эндпоинт `/analytics/timeseries` — трафик и подключения по часам/дням |
| 3.1.2 | График трафика | Line chart: трафик за 24ч/7д/30д с переключателем периода |
| 3.1.3 | График подключений | Area chart: активные подключения по нодам (stacked) |
| 3.1.4 | Дельта-индикаторы | На карточках статистики: "+12% за сутки", "-3 ноды за неделю" |

### 3.2 Node Fleet (карточки серверов)

| # | Задача | Описание |
|---|--------|----------|
| 3.2.1 | Backend: метрики нод | Расширить `/nodes` — uptime, версия Xray, последний рестарт, скорость |
| 3.2.2 | Карточки нод на Dashboard | Компактные карточки: статус-индикатор, IP, пользователей онлайн, трафик сегодня, uptime |
| 3.2.3 | Быстрые действия | На карточках: перезапуск, включить/выключить (без перехода на страницу Nodes) |
| 3.2.4 | Группировка | По статусу: сначала проблемные (offline), потом рабочие |

### 3.3 Системный статус

| # | Задача | Описание |
|---|--------|----------|
| 3.3.1 | Расширенный health check | API: время отклика, версия, uptime; БД: размер, кол-во записей; Ноды: детали |
| 3.3.2 | Карточка системы | Блок: API response time, DB pool usage, активные WebSocket, время работы |

---

## Фаза 4 — Улучшение существующих функций

### 4.1 Массовые операции

| # | Задача | Описание |
|---|--------|----------|
| 4.1.1 | Выбор нескольких пользователей | Чекбоксы в таблице Users, кнопки "Выбрать всё / Снять" |
| 4.1.2 | Массовые действия | Включить / Выключить / Удалить / Изменить лимит трафика / Продлить подписку |
| 4.1.3 | Backend: batch endpoints | `POST /users/batch/enable`, `/batch/disable`, `/batch/update` |
| 4.1.4 | Подтверждение | Диалог: "Вы уверены? Затронуто N пользователей" с предпросмотром |

### 4.2 Экспорт данных

| # | Задача | Описание |
|---|--------|----------|
| 4.2.1 | Экспорт пользователей | CSV/JSON: текущая выборка (с фильтрами) или все |
| 4.2.2 | Экспорт нарушений | CSV: дата, пользователь, скор, severity, причины, IP |
| 4.2.3 | Экспорт статистики | PDF/PNG: текущий dashboard (для отчётов) |

### 4.3 Улучшенный поиск

| # | Задача | Описание |
|---|--------|----------|
| 4.3.1 | Глобальный поиск | Command Palette (Cmd+K): поиск пользователей, нод, хостов из любой страницы |
| 4.3.2 | Сохранённые фильтры | Возможность сохранить набор фильтров и быстро переключаться |
| 4.3.3 | Расширенный поиск нарушений | По IP, по стране, по ASN, по диапазону дат |

### 4.4 Улучшения UX

| # | Задача | Описание |
|---|--------|----------|
| 4.4.1 | Toast-уведомления | Уведомления о действиях (создано, обновлено, ошибка) вместо alert |
| 4.4.2 | Skeleton-загрузки | Скелетоны при загрузке данных вместо спиннеров |
| 4.4.3 | Keyboard shortcuts | Горячие клавиши: Esc закрыть модал, Enter подтвердить, навигация по таблице |
| 4.4.4 | Breadcrumbs | Навигация: Dashboard > Users > user@email |

---

## Фаза 5 — Новые функции

### 5.1 Журнал аудита (Audit Log)

| # | Задача | Описание |
|---|--------|----------|
| 5.1.1 | Таблица `audit_log` | admin_id, action, resource, resource_id, details (JSON), ip, timestamp |
| 5.1.2 | Backend: автоматическая запись | Middleware: логировать все мутирующие действия (POST/PUT/DELETE) |
| 5.1.3 | Страница «Журнал» | Timeline с фильтрами: по админу, по ресурсу, по периоду |
| 5.1.4 | На карточке пользователя | Вкладка "История": кто и когда менял настройки пользователя |

### 5.2 Системные логи

| # | Задача | Описание |
|---|--------|----------|
| 5.2.1 | API для чтения логов | Стриминг логов бота и бэкенда через WebSocket |
| 5.2.2 | Страница «Логи» | Real-time просмотр логов с фильтрами по уровню (INFO/WARNING/ERROR) |
| 5.2.3 | Поиск по логам | Grep-подобный поиск по содержимому |

### 5.3 Проверка обновлений

| # | Задача | Описание |
|---|--------|----------|
| 5.3.1 | Backend: version check | Сравнение текущей версии с GitHub Releases API |
| 5.3.2 | Блок на Dashboard | Текущая версия + доступное обновление + changelog |
| 5.3.3 | Проверка зависимостей | Версии Xray на нодах, версия PostgreSQL, Python |

### 5.4 Расширенная аналитика

| # | Задача | Описание |
|---|--------|----------|
| 5.4.1 | Географическая карта | Карта подключений пользователей (heatmap по странам) |
| 5.4.2 | Топ пользователей по трафику | Рейтинг с графиками потребления |
| 5.4.3 | Анализ тенденций | Рост пользователей, трафика, нарушений за период |

---

## Приоритетность фаз

```
Фаза 1 (shadcn/ui)          ██████████  Фундамент — делается первой
Фаза 2 (RBAC)               █████████   Ключевая фича — сразу после UI
Фаза 3 (Dashboard)          ████████    Улучшение главной страницы
Фаза 4 (Improvements)       ███████     Параллельно с Фазой 3
Фаза 5 (New features)       ██████      Новый функционал на готовом фундаменте
```

### Порядок реализации

1. **Фаза 1** — сначала, потому что все дальнейшие страницы будут строиться на shadcn/ui
2. **Фаза 2** — RBAC нужен рано, т.к. влияет на все остальные фичи (permission-aware UI)
3. **Фаза 3 + 4** — параллельно, улучшают разные части панели
4. **Фаза 5** — после стабилизации основы

---

## Технические решения

### shadcn/ui + Vite

shadcn/ui официально поддерживает Vite. Настройка:
```bash
npx shadcn-ui@latest init
# Framework: Vite
# Style: Default
# Base color: Slate (для тёмной темы)
# CSS variables: Yes
```

Замена иконок: `react-icons/hi` → `lucide-react` (shadcn использует Lucide).

### RBAC: проверка прав

```python
# Backend: декоратор
@router.post("/users")
async def create_user(
    data: CreateUserRequest,
    admin: AdminUser = Depends(get_current_admin),
    _: None = Depends(require_permission("users", "create")),
    __: None = Depends(check_quota("max_users")),
):
    ...
```

```tsx
// Frontend: компонент
<PermissionGate resource="users" action="create">
  <Button onClick={openCreateDialog}>Создать пользователя</Button>
</PermissionGate>
```

### Временные ряды для графиков

Новая таблица для хранения метрик (или агрегация из существующих данных):
```sql
CREATE TABLE metrics_snapshots (
    id SERIAL PRIMARY KEY,
    metric_name VARCHAR(100),     -- "traffic_bytes", "users_online", "connections"
    metric_value DOUBLE PRECISION,
    node_uuid UUID,               -- NULL для глобальных метрик
    recorded_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_metrics_name_time ON metrics_snapshots(metric_name, recorded_at);
```

---

## Что НЕ планируется (и почему)

| Идея | Причина отказа |
|------|---------------|
| Плагины/скрипты (как в «Решала») | Избыточная сложность, другой scope проекта |
| Конфигуратор установки | Docker Compose + .env покрывает потребности |
| Мультиязычность веб-панели | Русский достаточен, бот уже поддерживает en/ru |
| Мониторинг CPU/RAM серверов | Требует агента на каждом сервере, выходит за рамки |

---

*Последнее обновление: Февраль 2026*
