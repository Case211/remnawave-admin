# Web Panel — Roadmap v2

План развития веб-панели Remnawave Admin.

---

## Текущее состояние

Веб-панель представляет собой полнофункциональную систему управления VPN-инфраструктурой. Ниже — сводка всего, что реализовано на данный момент.

**Стек:** React 18, TypeScript, Vite, Tailwind CSS, shadcn/ui (Radix UI), React Query, Zustand, Recharts, Leaflet, Axios, Sonner, cmdk

### Инфраструктура UI

- Дизайн-система на shadcn/ui: 17+ компонентов (Button, Card, Dialog, Table, Select, Badge, Tabs, Tooltip, DropdownMenu и др.)
- Тёмная тема с CSS-переменными (teal/cyan акценты), единая цветовая схема
- Иконки: lucide-react
- Адаптивный дизайн: desktop-таблицы + мобильные карточки на всех страницах
- Skeleton-загрузки, toast-уведомления (sonner), ConfirmDialog
- Command Palette (Cmd/Ctrl+K): навигация, быстрые действия, live-поиск пользователей
- Breadcrumbs с динамическим разрешением имён
- Сохранённые фильтры (Zustand + localStorage)

### Страницы и функции

| Страница | Функциональность |
|----------|-----------------|
| **Dashboard** | Карточки статистики с дельта-индикаторами, графики трафика (stacked area chart по нодам, переключатель 24ч/7д/30д), парк серверов (компактные карточки с быстрыми действиями), системный статус (API, PostgreSQL, ноды, WebSocket), проверка обновлений (GitHub Releases API) |
| **Users** | CRUD с пагинацией/фильтрацией/сортировкой, массовые операции (чекбоксы, enable/disable/delete/reset-traffic, до 100 за раз), экспорт CSV/JSON |
| **User Detail** | Трафик, HWID устройства, нарушения, история действий админов (timeline) |
| **Nodes** | CRUD, статус, перезапуск Xray, агент-токены (генерация/отзыв/статус), enable/disable |
| **Fleet** | Мониторинг парка нод: CPU, RAM, диск, скорость DL/UL, uptime, Xray-версия, пользователи онлайн |
| **Hosts** | CRUD, inbound конфигурация, security layer (TLS, Reality, XTLS), SNI/host/path, порты, позиционирование |
| **Violations** | Просмотр нарушений с IP Lookup и скор-разбивкой (temporal, geo, ASN, profile, device), фильтры по IP/стране/дате, resolve-действия, экспорт CSV/JSON |
| **Automations** | Конструктор правил (4-шаговый визард), 3 типа триггеров (событие/расписание/порог), 7 типов действий, 6 готовых шаблонов, лог срабатываний, dry-run тестирование, CRON-билдер |
| **Analytics** | Географическая карта подключений (Leaflet), топ пользователей по трафику, анализ тенденций (area chart) |
| **Admins** | CRUD админов, конструктор ролей (матрица прав 9 ресурсов × 5 действий), прогресс-бары лимитов, журнал аудита |
| **Audit Log** | Автоматическое логирование всех мутаций (middleware), фильтры по админу/ресурсу/периоду, экспорт, real-time через WebSocket |
| **System Logs** | Real-time стриминг логов через WebSocket, 4 источника (web/bot × INFO/WARNING), фильтр по уровню и тексту, live/paused режим |
| **Settings** | Динамические настройки (3-tier: DB > .env > defaults), категории, маскировка секретов, IP whitelist, статус синхронизации |
| **Login** | Telegram Login Widget + логин/пароль, JWT (access + refresh), определение первого запуска (форма регистрации первого админа) |

### Системные возможности

- **RBAC**: 4 системные роли (superadmin, manager, operator, viewer), PermissionGate на всех страницах, квоты для админов
- **WebSocket**: real-time обновления (ноды, пользователи, нарушения, аудит), автоматическая инвалидация React Query кеша, toast-уведомления о действиях других админов
- **Движок автоматизаций**: обработка событий, CRON/interval планировщик (60с цикл), мониторинг порогов (5-мин цикл), lock на повторное срабатывание (30с), интеграция с WebSocket
- **Аудит**: AuditMiddleware перехватывает все POST/PUT/PATCH/DELETE, broadcast через WebSocket
- **Проверка обновлений**: GitHub Releases API с 30-мин кешем, семантическое сравнение версий

### База данных (16 миграций Alembic)

Основные таблицы: `users`, `nodes`, `hosts`, `violations`, `ip_metadata`, `hwid_devices`, `bot_config`, `admin_roles`, `admin_permissions`, `admin_accounts`, `admin_audit_log`, `automation_rules`, `automation_log`, `node_agent_tokens`

### Backend API (14 модулей маршрутов)

`auth`, `users`, `nodes`, `hosts`, `violations`, `analytics`, `advanced_analytics`, `automations`, `settings`, `admins`, `roles`, `audit`, `logs`, `websocket`

---

## Выполненные фазы (архив)

| Фаза | Название | Описание |
|------|----------|----------|
| 1 | Миграция на shadcn/ui | Все страницы + Layout мигрированы. Единая дизайн-система, CSS-переменные, lucide-react |
| 2 | RBAC | 4 роли, матрица прав, CRUD админов и ролей, квоты, Permission-aware UI, совместимость с legacy auth |
| 3 | Улучшение Dashboard | Графики трафика, дельта-индикаторы, карточки нод с быстрыми действиями, системный статус |
| 4 | Улучшение функций | Массовые операции, экспорт CSV/JSON, Command Palette, сохранённые фильтры, toast/ConfirmDialog/breadcrumbs |
| 5 | Новые функции | Аудит-лог с middleware, системные логи, проверка обновлений, расширенная аналитика (гео + тренды), реалтайм-уведомления |
| 6 | Автоматизации | Конструктор правил, 3 типа триггеров, 7 действий, 6 шаблонов, движок с CRON/threshold/event, dry-run |

---

## Фаза 7 — Уведомления и алерты

**Зачем:** Сейчас уведомления — это toast'ы в панели и Telegram через автоматизации. Нужна полноценная подсистема уведомлений: центр уведомлений в UI, гибкая настройка каналов, эскалация.

### 7.1 Центр уведомлений (in-app)

| # | Задача | Описание |
|---|--------|----------|
| 7.1.1 | Модель данных | Таблица `notifications`: admin_id, type, title, body, is_read, link, created_at |
| 7.1.2 | Backend: API | CRUD, mark read/unread, mark all read, delete old |
| 7.1.3 | Frontend: иконка в Header | Bell с бейджем непрочитанных, dropdown с последними уведомлениями |
| 7.1.4 | Frontend: страница уведомлений | Полный список с фильтрами, группировкой по дате, массовой пометкой |
| 7.1.5 | WebSocket интеграция | Новое уведомление → push через WS → обновление бейджа + toast |

### 7.2 Каналы доставки

| # | Задача | Описание |
|---|--------|----------|
| 7.2.1 | Telegram | Отправка в личку админа / группу. Уже частично есть в автоматизациях — унифицировать |
| 7.2.2 | Webhook | POST на указанный URL с JSON payload. Шаблоны для Discord, Slack |
| 7.2.3 | Email (опционально) | SMTP настройка, HTML-шаблоны для отчётов и алертов |
| 7.2.4 | Настройка каналов на уровне админа | Каждый админ выбирает: какие события, через какой канал |

### 7.3 Правила алертов

| # | Задача | Описание |
|---|--------|----------|
| 7.3.1 | Пороговые алерты | Диск > 90%, ноды offline > N мин, трафик > X ГБ/сутки |
| 7.3.2 | Группировка и дедупликация | Не дублировать одинаковые алерты, группировать по типу |
| 7.3.3 | Эскалация | Если алерт не подтверждён за N минут → уведомить вышестоящего админа |

---

## Фаза 8 — Тестирование и стабильность

**Зачем:** Проект вырос до 14 страниц, 14 API-модулей, 16 миграций. Без тестов любое изменение может сломать существующую функциональность.

### 8.1 Frontend-тесты

| # | Задача | Описание |
|---|--------|----------|
| 8.1.1 | Настройка Vitest | vitest.config.ts, jsdom, setup файл с моками (React Query, Zustand, Axios) |
| 8.1.2 | Тесты утилит | export.ts, helpers.ts (автоматизации), форматирование байт/дат, CRON-парсер |
| 8.1.3 | Тесты хуков | useHasPermission, useWebSocket, useFiltersStore — поведение и edge cases |
| 8.1.4 | Компонентные тесты | PermissionGate, ConfirmDialog, ExportDropdown, CommandPalette — рендеринг и взаимодействие |
| 8.1.5 | Тесты страниц (smoke) | Каждая страница рендерится без ошибок с замоканными данными |

### 8.2 Backend-тесты

| # | Задача | Описание |
|---|--------|----------|
| 8.2.1 | Настройка pytest | conftest.py, фикстуры (тестовая БД, admin user, mock upstream API) |
| 8.2.2 | Тесты API | Каждый эндпоинт: happy path + ошибки + RBAC (403 для недостаточных прав) |
| 8.2.3 | Тесты RBAC | Матрица: каждая роль × каждый ресурс × каждое действие |
| 8.2.4 | Тесты автоматизаций | AutomationEngine: события, CRON, пороги, условия, блокировка повторов |
| 8.2.5 | Тесты миграций | Alembic upgrade/downgrade для всех 16 миграций |

### 8.3 E2E-тесты

| # | Задача | Описание |
|---|--------|----------|
| 8.3.1 | Настройка Playwright | playwright.config.ts, docker-compose для тестового окружения |
| 8.3.2 | Критические сценарии | Логин → создание пользователя → редактирование → удаление. Создание ноды → проверка статуса. RBAC: viewer не видит кнопку «Создать» |
| 8.3.3 | CI интеграция | GitHub Actions: lint + typecheck + unit tests + E2E на каждый PR |

---

## Фаза 9 — Мультиязычность (i18n)

**Зачем:** Панель используется не только русскоязычными админами. i18n позволит расширить аудиторию без дублирования кода.

### 9.1 Инфраструктура

| # | Задача | Описание |
|---|--------|----------|
| 9.1.1 | Настройка react-i18next | i18n.ts, языковые файлы в `locales/`, определение языка из настроек админа |
| 9.1.2 | Извлечение строк | Все hardcoded строки → `t('key')`. Namespace-разделение: common, pages/*, components/* |
| 9.1.3 | Русский (ru) | Базовый язык — перенос текущих строк |
| 9.1.4 | Английский (en) | Полный перевод |

### 9.2 Интеграция

| # | Задача | Описание |
|---|--------|----------|
| 9.2.1 | Переключатель языка | В Header или Settings, сохранение в профиле админа |
| 9.2.2 | Форматирование | Даты, числа, байты — через Intl API с учётом локали |
| 9.2.3 | Backend: i18n ошибок | Коды ошибок вместо текстовых сообщений, перевод на фронте |
| 9.2.4 | Автоматизации: шаблоны уведомлений | Шаблоны Telegram/webhook с поддержкой языка |

---

## Фаза 10 — Оптимизация производительности

**Зачем:** С ростом числа пользователей и нод таблицы становятся тяжёлыми, дашборд загружает много данных параллельно, бандл фронтенда растёт.

### 10.1 Frontend

| # | Задача | Описание |
|---|--------|----------|
| 10.1.1 | Code splitting | React.lazy + Suspense для каждой страницы. Уменьшить initial bundle |
| 10.1.2 | Виртуализация таблиц | @tanstack/react-virtual для Users/Violations (1000+ строк) |
| 10.1.3 | Оптимизация re-renders | React.memo, useMemo, useCallback для тяжёлых компонентов (графики, карта, таблицы) |
| 10.1.4 | Оптимизация Leaflet | Lazy-load карты, кластеризация маркеров (react-leaflet-cluster) при 100+ точек |
| 10.1.5 | Service Worker | Кеширование статики, offline-индикатор |

### 10.2 Backend

| # | Задача | Описание |
|---|--------|----------|
| 10.2.1 | Кеширование Redis | Результаты analytics, geo-данных, top users (TTL 1-5 мин) |
| 10.2.2 | Пагинация cursor-based | Заменить offset-пагинацию для больших таблиц (users, audit_log, automation_log) |
| 10.2.3 | Индексы БД | Аудит текущих запросов (EXPLAIN ANALYZE), добавление составных индексов |
| 10.2.4 | Сжатие WebSocket | Включить permessage-deflate для WebSocket при большом трафике данных |
| 10.2.5 | Rate limiting | Гранулярные лимиты по эндпоинтам (не только глобальный) |

---

## Фаза 11 — Бэкап, импорт и миграция

**Зачем:** Возможность экспортировать всю конфигурацию, перенести на другой сервер, восстановить после сбоя.

### 11.1 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 11.1.1 | Экспорт конфигурации | JSON-файл со всеми настройками, ролями, планами, правилами автоматизации |
| 11.1.2 | Импорт конфигурации | Загрузка JSON + валидация + применение (с диалогом конфликтов) |
| 11.1.3 | Бэкап БД из панели | Кнопка → pg_dump → скачивание архива. Расписание через автоматизации |
| 11.1.4 | Восстановление из бэкапа | Загрузка архива → pg_restore с подтверждением |
| 11.1.5 | Миграция пользователей | Импорт пользователей из CSV/JSON (массовое создание с валидацией) |
| 11.1.6 | Лог миграций | История импортов/экспортов с результатами (N успешно, M ошибок) |

---

## Фаза 12 — API для внешних интеграций

**Зачем:** Позволить внешним системам (биллинг, CRM, боты продаж, мониторинг) взаимодействовать с панелью по API без доступа к внутренним эндпоинтам.

### 12.1 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 12.1.1 | API-ключи | Генерация API-ключей для внешних систем с привязкой к роли/правам |
| 12.1.2 | Public API (v3) | Отдельный набор эндпоинтов: создание/управление пользователями, проверка статуса, получение подписки |
| 12.1.3 | Webhook-подписки | Подписка внешних систем на события (user.created, user.expired, node.offline) |
| 12.1.4 | Документация API | OpenAPI/Swagger UI с примерами, доступный из панели |
| 12.1.5 | Rate limiting для API-ключей | Индивидуальные лимиты на каждый ключ |
| 12.1.6 | SDK / примеры | Python и JavaScript клиенты, примеры интеграции с WHMCS, Telegram-ботами продаж |

---

## Приоритетность фаз

```
Выполнено:
  Фаза 1 (shadcn/ui)          ██████████  Дизайн-система                      ✅
  Фаза 2 (RBAC)               ██████████  Роли и права                        ✅
  Фаза 3 (Dashboard)          ██████████  Графики и мониторинг                ✅
  Фаза 4 (Improvements)       ██████████  Массовые операции, поиск, UX        ✅
  Фаза 5 (New features)       ██████████  Аудит, логи, аналитика              ✅
  Фаза 6 (Automations)        ██████████  Конструктор правил                  ✅

Планируется:
  Фаза 7  (Notifications)      █████████  Центр уведомлений, каналы
  Фаза 8  (Testing)            ████████   Unit + E2E тесты, CI
  Фаза 9  (i18n)               ███████    Мультиязычность
  Фаза 10 (Performance)        ██████     Оптимизация, кеширование
  Фаза 11 (Backup)             ██████     Бэкап, импорт, миграция
  Фаза 12 (External API)       █████      API-ключи, SDK, документация
```

### Порядок реализации

1. **Фаза 7** — уведомления: дополняет автоматизации и мониторинг, даёт админам контроль над каналами доставки
2. **Фаза 8** — тестирование: кодовая база достаточно большая, тесты — необходимость для стабильности
3. **Фаза 9** — i18n: расширение аудитории, не блокирует другие фичи
4. **Фаза 10** — производительность: оптимизация после стабилизации функциональности
5. **Фаза 11** — бэкап: важно для production, но не блокирует разработку
6. **Фаза 12** — внешний API: последняя, т.к. требует стабильного внутреннего API

Фазы 8-12 могут выполняться параллельно, т.к. затрагивают разные слои.

---

## Что НЕ планируется (и почему)

| Идея | Причина отказа |
|------|---------------|
| Визард первого запуска | Настройка через `.env` достаточна для целевой аудитории (администраторы VPN-сервисов). Текущая форма создания первого админа покрывает базовый сценарий |
| Страница компонентов системы | Dashboard уже содержит SystemStatusCard с мониторингом всех компонентов (API, PostgreSQL, ноды, WebSocket). Выделенная страница — дублирование |
| Управление подписками / тарифами | Панель предназначена для администраторов, не для клиентов. Управление пользователями (лимиты, сроки, HWID) уже реализовано. Биллинг и тарифы — задача внешних систем |
| Система плагинов | Сторонний код, sandbox, маркетплейс — overkill. Автоматизации (Фаза 6) + внешний API (Фаза 12) закрывают эту потребность |
| Мониторинг CPU/RAM серверов | Требует системного агента на каждом сервере. Fleet уже показывает базовые метрики с Xray, для глубокого мониторинга лучше Prometheus + Grafana |
| Встроенная платёжная система | Панель только для админов. Внешний API (Фаза 12) позволит подключить любой биллинг |
| PWA / мобильное приложение | Адаптивный дизайн достаточен для мобильных. Нативное приложение не оправдывает затраты для админ-панели |

---

*Последнее обновление: Февраль 2026*
