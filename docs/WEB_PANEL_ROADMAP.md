# Web Panel — Roadmap v2

План развития веб-панели Remnawave Admin.

---

## Текущее состояние

Веб-панель представляет собой полнофункциональную систему управления VPN-инфраструктурой. Ниже — сводка всего, что реализовано на данный момент.

**Стек:** React 18, TypeScript, Vite, Tailwind CSS, shadcn/ui (Radix UI), React Query, Zustand, Recharts, Leaflet, Axios, Sonner, cmdk, react-i18next

### Инфраструктура UI

- Дизайн-система на shadcn/ui: 23+ компонентов (Button, Card, Dialog, Table, Select, Badge, Tabs, Tooltip, DropdownMenu, Sheet, Switch, Checkbox, Popover, ScrollArea, Skeleton, Separator, Breadcrumb, Command и др.)
- Тёмная тема с CSS-переменными (teal/cyan акценты), единая цветовая схема
- Иконки: lucide-react
- Адаптивный дизайн: desktop-таблицы + мобильные карточки на всех страницах
- Skeleton-загрузки, toast-уведомления (sonner), ConfirmDialog
- Command Palette (Cmd/Ctrl+K): навигация, быстрые действия, live-поиск пользователей
- Breadcrumbs с динамическим разрешением имён
- Сохранённые фильтры (Zustand + localStorage)
- Мультиязычность (react-i18next): RU/EN, переключатель в Header, localStorage + navigator detection
- PWA: Service Worker (vite-plugin-pwa), precache, offline-индикатор
- Code splitting: React.lazy + Suspense для каждой страницы, manual chunks для vendor-библиотек
- Виртуализация таблиц: @tanstack/react-virtual для Users

### Страницы и функции

| Страница | Функциональность |
|----------|-----------------|
| **Dashboard** | Карточки статистики с дельта-индикаторами, графики трафика (stacked area chart по нодам, переключатель 24ч/7д/30д), парк серверов (компактные карточки с быстрыми действиями), системный статус (API, PostgreSQL, ноды, WebSocket), проверка обновлений (GitHub Releases API) |
| **Users** | CRUD с пагинацией/фильтрацией/сортировкой, массовые операции (чекбоксы, enable/disable/delete/reset-traffic, до 100 за раз), экспорт CSV/JSON, виртуализация таблиц |
| **User Detail** | Трафик, стратегия сброса трафика (NO_RESET/DAY/WEEK/MONTH), HWID устройства (полный CRUD: список, удаление, лимит, платформа, модель, версия), подписка (URL, copy-to-clipboard), нарушения, история действий админов (timeline) |
| **Nodes** | CRUD, статус, перезапуск Xray, агент-токены (генерация/отзыв/статус), enable/disable |
| **Fleet** | Мониторинг парка нод: CPU, RAM, диск, скорость DL/UL, uptime, Xray-версия, пользователи онлайн |
| **Hosts** | CRUD, inbound конфигурация, security layer (TLS, Reality, XTLS), SNI/host/path, порты, позиционирование |
| **Violations** | Просмотр нарушений с IP Lookup и скор-разбивкой (temporal, geo, ASN, profile, device), фильтры по IP/стране/дате, resolve-действия, экспорт CSV/JSON |
| **Automations** | Конструктор правил (4-шаговый визард), 3 типа триггеров (событие/расписание/порог), 7 типов действий, 6 готовых шаблонов, лог срабатываний, dry-run тестирование, CRON-билдер |
| **Analytics** | Географическая карта подключений (Leaflet, lazy-load), топ пользователей по трафику, анализ тенденций (area chart) |
| **Admins** | CRUD админов, конструктор ролей (матрица прав 9 ресурсов × 5 действий), прогресс-бары лимитов, журнал аудита |
| **Audit Log** | Автоматическое логирование всех мутаций (middleware), фильтры по админу/ресурсу/периоду, экспорт, real-time через WebSocket |
| **System Logs** | Real-time стриминг логов через WebSocket, 4 источника (web/bot × INFO/WARNING), фильтр по уровню и тексту, live/paused режим |
| **Notifications** | Центр уведомлений: 4 вкладки (уведомления, правила алертов, логи алертов, каналы). Bell-иконка в Header с бейджем непрочитанных и dropdown. CRUD правил алертов с кастомными шаблонами. 4 канала доставки (in-app, Telegram, Webhook, Email). Per-admin настройка каналов |
| **Mail Server** | Управление почтовым сервером: домены (DKIM, SPF, DMARC, PTR верификация), очередь отправки (retry/cancel), входящие письма, отправка тестовых, SMTP-креденшлы для внешних клиентов |
| **Settings** | Динамические настройки (3-tier: DB > .env > defaults), категории, маскировка секретов, IP whitelist, статус синхронизации |
| **Login** | Telegram Login Widget + логин/пароль, JWT (access + refresh), определение первого запуска (форма регистрации первого админа) |

### Системные возможности

- **RBAC**: 4 системные роли (superadmin, manager, operator, viewer), PermissionGate на всех страницах, квоты для админов
- **WebSocket**: real-time обновления (ноды, пользователи, нарушения, аудит, уведомления), автоматическая инвалидация React Query кеша, toast-уведомления о действиях других админов, exponential backoff reconnection
- **Движок автоматизаций**: обработка событий, CRON/interval планировщик (60с цикл), мониторинг порогов (5-мин цикл), lock на повторное срабатывание (30с), интеграция с WebSocket
- **Система уведомлений**: 4 канала (in-app, Telegram, Webhook, Email), правила алертов с кастомными шаблонами, дедупликация (5-мин окно), per-admin настройка каналов, severity levels
- **Почтовый сервер**: встроенный SMTP inbound/outbound, DKIM-подпись, DNS-верификация доменов (MX, SPF, DKIM, DMARC, PTR), очередь отправки, SMTP-креденшлы
- **Аудит**: AuditMiddleware перехватывает все POST/PUT/PATCH/DELETE, broadcast через WebSocket
- **Проверка обновлений**: GitHub Releases API с 30-мин кешем, семантическое сравнение версий
- **i18n**: react-i18next, 2 локали (RU/EN), useFormatters() хук для Intl API, переключатель языка в Header
- **PWA**: Service Worker с precache (48 записей), runtime cache (Google Fonts, map tiles), offline-индикатор

### База данных (22 миграции Alembic)

Основные таблицы: `users`, `nodes`, `hosts`, `violations`, `ip_metadata`, `hwid_devices`, `bot_config`, `admin_roles`, `admin_permissions`, `admin_accounts`, `admin_audit_log`, `automation_rules`, `automation_log`, `node_agent_tokens`, `notifications`, `notification_channels`, `smtp_config`, `alert_rules`, `alert_rule_log`, `domain_config`, `email_queue`, `email_inbox`, `smtp_credentials`

### Backend API (19 модулей маршрутов)

`auth`, `users`, `nodes`, `hosts`, `violations`, `analytics`, `advanced_analytics`, `automations`, `settings`, `admins`, `roles`, `audit`, `logs`, `notifications`, `mailserver`, `websocket`, `deps`

---

## Выполненные фазы (архив)

| Фаза | Название | Описание |
|------|----------|----------|
| 1 | Миграция на shadcn/ui | Все страницы + Layout мигрированы. Единая дизайн-система, CSS-переменные, lucide-react |
| 2 | RBAC | 4 роли, матрица прав, CRUD админов и ролей, квоты, Permission-aware UI, совместимость с legacy auth |
| 3 | Улучшение Dashboard | Графики трафика, дельта-индикаторы, карточки нод с быстрыми действиями, системный статус |
| 4 | Улучшение функций | Массовые операции, экспорт CSV/JSON, Command Palette, сохранённые фильтры, toast/ConfirmDialog/breadcrumbs |
| 5 | Новые функции | Аудит-лог с middleware, системные логи, проверка обновлений, расширенная аналитика (гео + тренды), реалтайм-уведомления |
| 6 | Автоматизации | Конструктор правил, 3 типа триггеров, 7 действий, 6 шаблонов, движок с CRON/threshold/event, dry-run |
| 10 | Уведомления и алерты | Центр уведомлений (bell + dropdown + страница), 4 канала (in-app, Telegram, Webhook, Email), правила алертов с шаблонами, дедупликация, per-admin каналы |
| 10+ | Почтовый сервер | Встроенный SMTP (inbound/outbound), домены с DKIM/SPF/DMARC/PTR, очередь отправки, SMTP-креденшлы для внешних клиентов |
| 11 | Тестирование | Frontend: Vitest (10 тестов), Backend: pytest (14 тестов, RBAC-матрица), E2E: Playwright (Chromium + Firefox), CI: GitHub Actions |
| 12 | Мультиязычность (frontend) | react-i18next, RU/EN локали, переключатель языка, useFormatters() хук |
| 13 (frontend) | Оптимизация frontend | Code splitting (16 чанков), виртуализация таблиц, React.memo, lazy Leaflet, Service Worker/PWA |

---

## Фаза 7 — Управление нодами (Fleet Management Center)

**Зачем:** Сейчас Fleet — пассивный мониторинг (CPU, RAM, диск, скорость, uptime). Node Agent только читает логи и `/proc/*`. Администраторы VPN-инфраструктуры вынуждены подключаться к каждому серверу по SSH вручную для рутинных задач: установки ПО, настройки фаервола, обновления Xray, hardening. Эта фаза превращает Fleet в полноценный центр управления нодами.

**Ключевое решение:** Node Agent расширяется модулем Command Runner — агент устанавливает исходящее WebSocket-соединение к бэкенду (не требует открытия портов на ноде, работает через NAT/файрвол). Обратная совместимость: `AGENT_COMMAND_ENABLED=false` по умолчанию.

**Безопасность:** HMAC-подпись каждой команды (backend подписывает, агент проверяет), whitelist разрешённых операций, FORBIDDEN_PATTERNS, таймауты, полная запись всех действий в аудит.

### 7.1 Архитектура: расширение Node Agent v2

| # | Задача | Описание |
|---|--------|----------|
| 7.1.1 | Модель данных | Alembic: таблицы `node_ssh_keys`, `node_command_log`, `node_scripts`, `node_provision_sessions` |
| 7.1.2 | RBAC permissions | `fleet.terminal` (superadmin), `fleet.scripts` (superadmin+manager), `fleet.provision` (superadmin) |
| 7.1.3 | Протокол команд | JSON через WebSocket: exec_script, shell_session, pty_input/output, ping/pong |
| 7.1.4 | HMAC-подпись | Backend подписывает команды SHA-256 от agent token, агент проверяет перед выполнением |
| 7.1.5 | Agent: WebSocket-клиент | `ws_client.py` — постоянное соединение к `wss://admin/api/v1/agent/ws` с переподключением |
| 7.1.6 | Agent: Command Runner | `command_runner.py` — маршрутизатор: скрипты, PTY, service_status. Whitelist + FORBIDDEN_PATTERNS |
| 7.1.7 | Agent: обновление config/main | Новые настройки + `asyncio.gather` для WS параллельно с метриками |
| 7.1.8 | Backend: WS-эндпоинт для агентов | `WS /api/v1/agent/ws` + Agent Connection Manager (реестр подключённых нод) |
| 7.1.9 | Backend: API статуса агентов | `GET /api/v2/fleet/agents` — список нод с agent v2 connected/disconnected |

### 7.2 Веб-терминал (SSH из браузера)

| # | Задача | Описание |
|---|--------|----------|
| 7.2.1 | Agent: PTY-провайдер | `pty_provider.py` — `os.openpty()` + `/bin/bash`, стриминг через WS. Не требует SSH-сервер |
| 7.2.2 | Backend: WS-прокси для PTY | `WS /api/v2/fleet/{node_uuid}/terminal` — мост xterm.js ↔ agent PTY |
| 7.2.3 | Backend: управление сессиями | Создание/закрытие, таймаут 30 мин бездействия, лимит 1 сессия на ноду на админа |
| 7.2.4 | Backend: запись сессий | Полная запись ввода/вывода в `node_command_log` (asciinema-совместимый формат) |
| 7.2.5 | Frontend: WebTerminal | xterm.js + addon-fit + addon-web-links, тёмная тема Remnawave |
| 7.2.6 | Frontend: UI терминала | Кнопка «Терминал» в карточке ноды, полноэкранный режим, история сессий |

### 7.3 Каталог скриптов

~20 встроенных скриптов + возможность создавать свои. Каждый скрипт — параметризованный bash с валидацией, таймаутом и live-стримингом вывода.

**Безопасность и защита:**

| Slug | Название | Описание |
|------|----------|----------|
| `fail2ban-install` | Установка fail2ban | Защита SSH и сервисов от brute-force. Параметры: maxretry, bantime |
| `ufw-setup` | Настройка UFW | Файрвол: SSH-порт + VPN-порты + custom. Параметры: порты, default policy |
| `ssh-hardening` | Усиление SSH | Отключение root, key-only auth, кастомный порт. Параметры: disable_root, port |
| `crowdsec-install` | CrowdSec | Community-driven threat intelligence + iptables bouncer |
| `ddos-protection` | DDoS-защита | iptables: SYN flood protection, rate limiting, drop invalid. Параметры: rate_limit |
| `auto-updates` | Авто-обновления | unattended-upgrades для security-патчей. Параметры: reboot_time, auto_reboot |

**Сеть и VPN:**

| Slug | Название | Описание |
|------|----------|----------|
| `bbr-enable` | TCP BBR | Включение BBR congestion control — критично для VPN-производительности |
| `xray-update` | Обновление Xray | Обновление до указанной или последней версии. Параметры: version |
| `wireguard-setup` | WireGuard | Установка, генерация ключей, настройка интерфейса. Параметры: port, server_ip |
| `dns-change` | Смена DNS | systemd-resolved или /etc/resolv.conf. Параметры: primary, secondary |
| `mtu-optimize` | Оптимизация MTU | Автоопределение оптимального MTU через PMTUD |

**Система:**

| Slug | Название | Описание |
|------|----------|----------|
| `docker-install` | Docker | Docker CE + Compose из официального репозитория |
| `swap-setup` | Swap | Создание swap-файла, настройка swappiness. Параметры: size_gb, swappiness |
| `disk-cleanup` | Очистка диска | apt cache, Docker prune, systemd journal, tmp |
| `kernel-tuning` | Тюнинг ядра | sysctl: net.core.*, net.ipv4.*, conntrack, somaxconn для VPN |
| `ntp-setup` | NTP/Timezone | systemd-timesyncd или chrony. Параметры: timezone |
| `certbot-install` | Let's Encrypt | Certbot + сертификат + auto-renewal. Параметры: domain, email |

**Мониторинг и автоматизация:**

| Slug | Название | Описание |
|------|----------|----------|
| `vnstat-install` | vnstat | Учёт трафика по интерфейсам |
| `network-diag` | Диагностика сети | mtr + speedtest-cli + ping → отчёт. Параметры: target |
| `logrotate-setup` | Ротация логов | Xray, nginx, системные логи. Параметры: max_size, keep_days |
| `backup-setup` | Настройка бэкапов | Конфиги Xray + БД, cron автозапуск. Параметры: path, cron |
| `system-update` | Обновление системы | apt update && apt upgrade. Параметры: reboot |

#### 7.3 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 7.3.1 | Backend: seed скриптов | Alembic-миграция: ~20 встроенных скриптов с параметрами, категориями, описаниями |
| 7.3.2 | Backend: CRUD API | `GET/POST/PUT/DELETE /api/v2/fleet/scripts` с RBAC |
| 7.3.3 | Backend: запуск скрипта | `POST /api/v2/fleet/{node_uuid}/scripts/{id}/run` с параметрами |
| 7.3.4 | Backend: стриминг вывода | `WS /api/v2/fleet/{node_uuid}/scripts/output?command_id=...` — live-вывод |
| 7.3.5 | Agent: script_executor | Запуск bash во временном файле, стриминг stdout/stderr, таймаут, cleanup |
| 7.3.6 | Frontend: каталог | Карточки с категориями, поиск, фильтры |
| 7.3.7 | Frontend: диалог запуска | Выбор ноды (или нескольких), параметры скрипта, подтверждение, live-вывод |
| 7.3.8 | Frontend: редактор скриптов | Создание пользовательских скриптов (CodeMirror/Monaco с подсветкой bash) |
| 7.3.9 | Frontend: история выполнений | Список запусков с фильтрами по ноде/скрипту/статусу/админу |

### 7.4 Провижининг нод

One-click настройка свежего VPS как VPN-ноды. Бэкенд подключается по SSH (asyncssh) и пошагово выполняет: обновление системы → базовые пакеты → безопасность (опционально: fail2ban, UFW, SSH hardening) → Docker → BBR + kernel tuning → Node Agent (docker-compose) → проверка связи.

| # | Задача | Описание |
|---|--------|----------|
| 7.4.1 | Backend: API провижининга | `POST /api/v2/fleet/provision`, `GET .../provision/{id}` — статус, шаги, лог |
| 7.4.2 | Backend: движок | `provision_engine.py` — пошаговое выполнение через asyncssh, стриминг статуса |
| 7.4.3 | Agent: install-скрипт | `install-agent.sh` — установка и настройка Node Agent на свежем сервере |
| 7.4.4 | Frontend: визард | 4 шага: подключение (IP/пароль, «Проверить связь») → выбор пакетов (чекбоксы) → прогресс (шаги с галочками + live-лог) → результат |

### 7.5 Интеграция в Fleet UI

| # | Задача | Описание |
|---|--------|----------|
| 7.5.1 | Вкладки Fleet | Мониторинг / Терминал / Скрипты / История / Провижининг |
| 7.5.2 | NodeDetailPanel | Кнопки «Терминал», «Скрипты», дропдаун быстрых скриптов (BBR, fail2ban, Xray update) |
| 7.5.3 | Статус Agent v2 | Индикатор WebSocket-соединения агента в карточке ноды (v1 HTTP / v2 WS) |
| 7.5.4 | Массовое выполнение | Чекбоксы на нодах → запуск скрипта на нескольких одновременно |

---

## Фаза 8 — Миграция функционала бота в панель

**Зачем:** Telegram-бот содержит функционал, которого нет в веб-панели: шаблоны VPN-конфигов, сниппеты, API-токены, биллинг инфраструктуры, провайдеры, отчёты, ASN-синхронизация. Цель — перенести всё в панель и свести бот к роли уведомлений и быстрого доступа.

**Что есть в боте, но НЕТ в вебке (актуальный статус):**

| Функционал | Бот | Вебка | Статус |
|-----------|-----|-------|--------|
| Шаблоны VPN-конфигов (templates) | CRUD | -- | ⏳ Перенести |
| Сниппеты конфигов (snippets) | CRUD | -- | ⏳ Перенести |
| API-токены Remnawave | CRUD | -- | ⏳ Перенести |
| Config profiles | CRUD | -- | ⏳ Перенести |
| Биллинг инфраструктуры | Просмотр | -- | ⏳ Перенести |
| Провайдеры (AWS, DO и т.д.) | CRUD | -- | ⏳ Перенести |
| Подписки (URL, revoke) | Управление | URL + copy | ✅ Частично (нет QR-кода) |
| Отчёты (daily/weekly/monthly) | Scheduled | -- | ⏳ Перенести |
| HWID устройства (CRUD) | Полный | Полный | ✅ Готово (список, удаление, лимит, платформа, модель, версия) |
| Настройки бота (bot_config) | Управление | -- | ⏳ В Settings |
| Синхронизация ASN | Запуск | -- | ⏳ Перенести |
| Traffic reset strategy | На пользователе | ✅ | ✅ Готово (NO_RESET/DAY/WEEK/MONTH) |

### 8.1 Ресурсы и конфигурация

| # | Задача | Описание |
|---|--------|----------|
| 8.1.1 | Страница «Шаблоны» | CRUD VPN-конфигов (templates): список, создание, редактирование, удаление |
| 8.1.2 | Страница «Сниппеты» | CRUD code snippets: список, редактор с подсветкой синтаксиса, фильтры |
| 8.1.3 | Страница «API-токены» | Генерация, список, отзыв токенов Remnawave API |
| 8.1.4 | Страница «Config Profiles» | CRUD конфигурационных профилей |

### 8.2 Биллинг и провайдеры

| # | Задача | Описание |
|---|--------|----------|
| 8.2.1 | Страница «Биллинг» | История платежей за инфраструктуру, суммы, сроки, overdue |
| 8.2.2 | Управление провайдерами | CRUD: название, favicon, URL, привязанные ноды |
| 8.2.3 | Биллинг нод | Стоимость каждой ноды, дата следующего платежа, overdue-алерты |
| 8.2.4 | Dashboard: виджет биллинга | Ближайшие платежи, суммарные расходы за месяц |

### 8.3 Подписки и HWID

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 8.3.1 | Управление подписками | ⚠️ | URL подписки + copy-to-clipboard реализованы. Осталось: QR-код, revoke, продление |
| 8.3.2 | HWID устройства | ✅ | Полный CRUD: список устройств (платформа, модель, OS, app version, user agent), удаление, лимит, пагинация, синхронизация |
| 8.3.3 | Traffic reset strategy | ✅ | В форме пользователя: NO_RESET / DAY / WEEK / MONTH + last_traffic_reset_at |

### 8.4 Отчёты и аналитика

| # | Задача | Описание |
|---|--------|----------|
| 8.4.1 | Генератор отчётов | Формирование: за день/неделю/месяц с графиками и сводкой |
| 8.4.2 | Расписание отчётов | Интеграция с автоматизациями: cron-триггер → отчёт → Telegram/email |
| 8.4.3 | ASN синхронизация | Секция в Settings: запуск синхронизации, настройка лимитов |

### 8.5 Настройки бота

| # | Задача | Описание |
|---|--------|----------|
| 8.5.1 | Bot Config в Settings | Секция настроек бота: язык, topic ID'ы, интервалы |
| 8.5.2 | Управление уведомлениями | Какие события отправлять в Telegram, в какие топики |

---

## Фаза 9 — Telegram Mini App

**Зачем:** После миграции основного функционала из бота в панель (Фаза 8), нужен лёгкий способ взаимодействия с панелью прямо из Telegram. Mini App — не замена полной панели, а быстрый доступ к ключевым функциям с телефона.

### 9.1 Инфраструктура

| # | Задача | Описание |
|---|--------|----------|
| 9.1.1 | Регистрация Mini App | Создать Web App через BotFather, настроить URL |
| 9.1.2 | Авторизация через initData | Валидация Telegram initData (HMAC), маппинг на admin_accounts |
| 9.1.3 | Отдельный build target | Vite config: отдельная entry point для Mini App (лёгкий бандл без тяжёлых зависимостей) |

### 9.2 Функционал

| # | Задача | Описание |
|---|--------|----------|
| 9.2.1 | Dashboard (компактный) | Ключевые метрики: онлайн, ноды, нарушения, трафик. Числа и дельты без графиков |
| 9.2.2 | Быстрый поиск пользователя | Поиск → карточка → enable/disable/reset traffic |
| 9.2.3 | Статус нод | Список: статус, users online. Tap → restart/enable/disable |
| 9.2.4 | Последние нарушения | Лента нарушений с быстрыми действиями (resolve) |
| 9.2.5 | Push-уведомления | При событиях (нода offline, нарушение) — Mini App уведомление |

### 9.3 UI/UX

| # | Задача | Описание |
|---|--------|----------|
| 9.3.1 | Telegram UI Kit | @telegram-apps/sdk, нативные цвета Telegram (theme_params) |
| 9.3.2 | Haptic feedback | Вибрация при действиях (Telegram WebApp API) |
| 9.3.3 | Bottom navigation | Tab bar: Dashboard / Users / Nodes / Alerts |
| 9.3.4 | Offline cache | Service Worker + IndexedDB для базовых данных |

---

## Фаза 10 — Уведомления и алерты ✅

**Зачем:** Сейчас уведомления — это toast'ы в панели и Telegram через автоматизации. Нужна полноценная подсистема уведомлений: центр уведомлений в UI, гибкая настройка каналов, эскалация.

**Статус: полностью реализовано** (миграции 0017-0022). Дополнительно реализован встроенный почтовый сервер, который не планировался в исходном роадмапе.

### 10.1 Центр уведомлений (in-app) ✅

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 10.1.1 | Модель данных | ✅ | Таблицы `notifications`, `notification_channels`, `alert_rules`, `alert_rule_log`, `smtp_config` |
| 10.1.2 | Backend: API | ✅ | CRUD, mark read/unread, mark all read, delete old (30+ дней) |
| 10.1.3 | Frontend: иконка в Header | ✅ | Bell с бейджем непрочитанных (99+), dropdown с 8 последними уведомлениями, severity-цвета, mark all read |
| 10.1.4 | Frontend: страница уведомлений | ✅ | 4 вкладки: уведомления, правила алертов, логи алертов, каналы. Фильтры по read/severity |
| 10.1.5 | WebSocket интеграция | ✅ | Топик `notification` → push через WS → обновление бейджа + toast. Auto-fetch каждые 30с |

### 10.2 Каналы доставки ✅

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 10.2.1 | Telegram | ✅ | Telegram Bot API с поддержкой topic/thread для разных типов алертов (nodes, service, users, errors, violations). Fallback на NOTIFICATIONS_CHAT_ID |
| 10.2.2 | Webhook | ✅ | POST на указанный URL с JSON payload. Совместимые форматы для Discord и Slack |
| 10.2.3 | Email | ✅ | **Встроенный почтовый сервер** (inbound/outbound SMTP, DKIM, DNS-верификация) + fallback на внешний SMTP relay. HTML-шаблоны |
| 10.2.4 | Настройка каналов на уровне админа | ✅ | Каждый админ выбирает каналы (in_app, telegram, webhook, email). Per-alert-rule настройка каналов |

### 10.3 Правила алертов ✅

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 10.3.1 | Пороговые алерты | ✅ | Конфигурируемые правила с severity, кастомными шаблонами (title_template, body_template) |
| 10.3.2 | Группировка и дедупликация | ✅ | 5-минутное окно дедупликации по group_key |
| 10.3.3 | Эскалация | ⏳ | Если алерт не подтверждён за N минут → уведомить вышестоящего админа (не реализовано) |

### 10.4 Почтовый сервер (бонус, не планировался) ✅

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 10.4.1 | Страница Mail Server | ✅ | 5 вкладок: домены, очередь, входящие, отправка, креденшлы |
| 10.4.2 | Управление доменами | ✅ | CRUD доменов, DNS-верификация (MX, SPF, DKIM, DMARC, PTR), per-domain sender name |
| 10.4.3 | SMTP inbound/outbound | ✅ | Приём и отправка писем, DKIM-подпись, очередь с retry/cancel |
| 10.4.4 | SMTP-креденшлы | ✅ | Аутентификация PLAIN/LOGIN на порту 587, rate limiting, ограничение доменов |
| 10.4.5 | Входящие письма | ✅ | Просмотр с HTML-рендерингом, mark read, удаление |

---

## Фаза 11 — Тестирование и стабильность ✅

**Зачем:** Проект вырос до 16+ страниц, 19+ API-модулей, 22+ миграций. Тесты — необходимость для стабильности.

### 11.1 Frontend-тесты ✅

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 11.1.1 | Настройка Vitest | ✅ | vitest.config.ts, jsdom, setup файл с моками (React Query, Zustand, Axios) |
| 11.1.2 | Тесты утилит | ✅ | export.ts, helpers.ts (автоматизации), форматирование байт/дат, CRON-парсер |
| 11.1.3 | Тесты хуков | ✅ | useHasPermission, useWebSocket, useFiltersStore — поведение и edge cases |
| 11.1.4 | Компонентные тесты | ✅ | PermissionGate, ConfirmDialog, ExportDropdown, CommandPalette — рендеринг и взаимодействие |
| 11.1.5 | Тесты страниц (smoke) | ✅ | Каждая страница рендерится без ошибок с замоканными данными |

### 11.2 Backend-тесты ✅

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 11.2.1 | Настройка pytest | ✅ | conftest.py, фикстуры (FastAPI TestClient, AdminUser с разными ролями, dependency overrides) |
| 11.2.2 | Тесты API | ✅ | Auth (login/register/refresh/me/logout), Admins (CRUD + self-protection), Health — happy path + ошибки + RBAC |
| 11.2.3 | Тесты RBAC | ✅ | Матрица: 4 роли (superadmin/manager/operator/viewer) × 14 ресурсов × 5 действий — параметризованные тесты |
| 11.2.4 | Тесты автоматизаций | ✅ | CRON-парсер, условия (8 операторов), target inference, engine lifecycle (start/stop) |
| 11.2.5 | Тесты миграций | ✅ | Валидация структуры файлов, линейность цепочки revision → down_revision, upgrade/downgrade наличие |
| 11.2.6 | Тесты безопасности | ✅ | JWT (create/decode/expiry), Telegram auth (HMAC, expiry, signature), bcrypt хеширование, LoginGuard, TokenBlacklist, IP whitelist |
| 11.2.7 | Тесты конфигурации | ✅ | WebSettings: CORS, ADMINS, JWT algorithm validation, defaults |

### 11.3 E2E-тесты ✅

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 11.3.1 | Настройка Playwright | ✅ | playwright.config.ts (Chromium + Firefox), webServer, CI reporter |
| 11.3.2 | Критические сценарии | ✅ | Login flow, auth guard (10 protected routes → redirect), navigation smoke (10 страниц с API mocking) |
| 11.3.3 | CI интеграция | ✅ | GitHub Actions: frontend unit tests + backend pytest + E2E Playwright на каждый PR |

---

## Фаза 12 — Мультиязычность (i18n)

**Зачем:** Панель используется не только русскоязычными админами. i18n позволит расширить аудиторию без дублирования кода.

### 12.1 Инфраструктура ✅

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 12.1.1 | Настройка react-i18next | ✅ | i18n.ts, языковые файлы в `locales/`, определение языка из настроек админа (localStorage + navigator detection) |
| 12.1.2 | Извлечение строк | ✅ | Все hardcoded строки → `t('key')`. 16 страниц + компоненты. Namespace-разделение |
| 12.1.3 | Русский (ru) | ✅ | Базовый язык — перенос текущих строк в `src/locales/ru/translation.json` |
| 12.1.4 | Английский (en) | ✅ | Полный перевод в `src/locales/en/translation.json` |

### 12.2 Интеграция

| # | Задача | Статус | Описание |
|---|--------|--------|----------|
| 12.2.1 | Переключатель языка | ✅ | Кнопка с Globe иконкой в Header, переключение RU/EN, сохранение в localStorage |
| 12.2.2 | Форматирование | ✅ | `useFormatters()` хук: даты, числа, байты, скорость — через Intl API с учётом локали |
| 12.2.3 | Backend: i18n ошибок | ⏳ | Сейчас бэкенд возвращает текстовые сообщения в `detail` поле HTTPException. Нужно: коды ошибок + перевод на фронте |
| 12.2.4 | Автоматизации: шаблоны уведомлений | ⏳ | Шаблоны автоматизаций используют простую подстановку плейсхолдеров ({rule_name}, {metric} и т.д.) без i18n. Нужно: поддержка языка в шаблонах |

---

## Фаза 13 — Оптимизация производительности

**Зачем:** С ростом числа пользователей и нод таблицы становятся тяжёлыми, дашборд загружает много данных параллельно, бандл фронтенда растёт.

### 13.1 Frontend ✅

| # | Задача | Описание | Статус |
|---|--------|----------|--------|
| 13.1.1 | Code splitting | React.lazy + Suspense для каждой страницы (16 чанков). Manual chunks: vendor-react, vendor-data, vendor-i18n, vendor-radix, vendor-charts, vendor-maps, vendor-icons | ✅ |
| 13.1.2 | Виртуализация таблиц | @tanstack/react-virtual для Users (30+ строк): sticky header, виртуальные spacers | ✅ |
| 13.1.3 | Оптимизация re-renders | React.memo для StatusBadge, TrafficBar, OnlineIndicator, MobileUserCard, ViolationCard, ScoreBar, StatCard и др. useMemo/useCallback для хэндлеров | ✅ |
| 13.1.4 | Оптимизация Leaflet | Lazy-load через React.lazy (LazyGeoMap) — карта + leaflet CSS загружаются только на вкладке Geography | ✅ |
| 13.1.5 | Service Worker | vite-plugin-pwa: precache 48 записей, runtime cache (Google Fonts, map tiles), offline-индикатор | ✅ |

### 13.2 Backend

| # | Задача | Описание |
|---|--------|----------|
| 13.2.1 | Кеширование Redis | Результаты analytics, geo-данных, top users (TTL 1-5 мин) |
| 13.2.2 | Пагинация cursor-based | Заменить offset-пагинацию для больших таблиц (users, audit_log, automation_log) |
| 13.2.3 | Индексы БД | Аудит текущих запросов (EXPLAIN ANALYZE), добавление составных индексов |
| 13.2.4 | Сжатие WebSocket | Включить permessage-deflate для WebSocket при большом трафике данных |
| 13.2.5 | Rate limiting | Гранулярные лимиты по эндпоинтам (не только глобальный) |

---

## Фаза 14 — Бэкап, импорт и миграция

**Зачем:** Возможность экспортировать всю конфигурацию, перенести на другой сервер, восстановить после сбоя.

### 14.1 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 14.1.1 | Экспорт конфигурации | JSON-файл со всеми настройками, ролями, правилами автоматизации, правилами алертов |
| 14.1.2 | Импорт конфигурации | Загрузка JSON + валидация + применение (с диалогом конфликтов) |
| 14.1.3 | Бэкап БД из панели | Кнопка → pg_dump → скачивание архива. Расписание через автоматизации |
| 14.1.4 | Восстановление из бэкапа | Загрузка архива → pg_restore с подтверждением |
| 14.1.5 | Миграция пользователей | Импорт пользователей из CSV/JSON (массовое создание с валидацией) |
| 14.1.6 | Лог миграций | История импортов/экспортов с результатами (N успешно, M ошибок) |

---

## Фаза 15 — API для внешних интеграций

**Зачем:** Позволить внешним системам (биллинг, CRM, боты продаж, мониторинг) взаимодействовать с панелью по API без доступа к внутренним эндпоинтам.

### 15.1 Задачи

| # | Задача | Описание |
|---|--------|----------|
| 15.1.1 | API-ключи | Генерация API-ключей для внешних систем с привязкой к роли/правам |
| 15.1.2 | Public API (v3) | Отдельный набор эндпоинтов: создание/управление пользователями, проверка статуса, получение подписки |
| 15.1.3 | Webhook-подписки | Подписка внешних систем на события (user.created, user.expired, node.offline). Учесть уже реализованный webhook-канал из Фазы 10 |
| 15.1.4 | Документация API | OpenAPI/Swagger UI с примерами, доступный из панели |
| 15.1.5 | Rate limiting для API-ключей | Индивидуальные лимиты на каждый ключ |
| 15.1.6 | SDK / примеры | Python и JavaScript клиенты, примеры интеграции с WHMCS, Telegram-ботами продаж |

---

## Приоритетность фаз

```
Выполнено:
  Фаза 1  (shadcn/ui)          ██████████  Дизайн-система                      ✅
  Фаза 2  (RBAC)               ██████████  Роли и права                        ✅
  Фаза 3  (Dashboard)          ██████████  Графики и мониторинг                ✅
  Фаза 4  (Improvements)       ██████████  Массовые операции, поиск, UX        ✅
  Фаза 5  (New features)       ██████████  Аудит, логи, аналитика              ✅
  Фаза 6  (Automations)        ██████████  Конструктор правил                  ✅
  Фаза 10 (Notifications)      ██████████  Уведомления, алерты, почта          ✅
  Фаза 11 (Testing)            ██████████  Unit + E2E тесты, CI               ✅
  Фаза 12 (i18n)               ██████████  Мультиязычность (фронтенд)          ✅
  Фаза 13 (Performance FE)     ██████████  Оптимизация фронтенда               ✅

Частично выполнено:
  Фаза 8  (Bot Migration)      ███░░░░░░░  HWID + traffic reset + подписки     ⚠️ (~30%)
  Фаза 12 (i18n backend)       ██░░░░░░░░  Нет кодов ошибок, нет i18n шаблонов ⚠️ (~80%)
  Фаза 13 (Performance BE)     ░░░░░░░░░░  Redis, cursor-based, индексы        ⚠️ (0%)

Планируется:
  Фаза 7  (Fleet Management)   ░░░░░░░░░░  SSH, скрипты, провижининг
  Фаза 8  (Bot Migration)      ░░░░░░░░░░  Шаблоны, сниппеты, биллинг, отчёты
  Фаза 9  (Mini App)           ░░░░░░░░░░  Telegram Mini App
  Фаза 14 (Backup)             ░░░░░░░░░░  Бэкап, импорт, миграция
  Фаза 15 (External API)       ░░░░░░░░░░  API-ключи, SDK, документация
```

### Порядок реализации (оставшиеся задачи)

1. **Фаза 7** — Fleet Management: превращает панель в полноценный инструмент управления инфраструктурой. SSH, каталог скриптов, провижининг нод
2. **Фаза 8** — миграция бота: переносит оставшийся функционал (шаблоны, сниппеты, API-токены, биллинг, провайдеры, отчёты, настройки бота). HWID, traffic reset strategy и подписки уже перенесены
3. **Фаза 9** — Mini App: лёгкий доступ к панели из Telegram после миграции основного функционала
4. **Фаза 13.2** — производительность бэкенда: Redis-кеширование, cursor-based пагинация, индексы БД
5. **Фаза 12.2** — i18n бэкенда: коды ошибок, i18n шаблонов автоматизаций/уведомлений
6. **Фаза 14** — бэкап: экспорт/импорт конфигурации, pg_dump/pg_restore из панели
7. **Фаза 15** — внешний API: API-ключи, webhook-подписки, SDK, документация

Фазы 13.2, 12.2, 14, 15 могут выполняться параллельно, т.к. затрагивают разные слои.

---

## Что НЕ планируется (и почему)

| Идея | Причина отказа |
|------|---------------|
| Визард первого запуска | Настройка через `.env` достаточна для целевой аудитории. Текущая форма создания первого админа покрывает базовый сценарий |
| Страница компонентов системы | Dashboard уже содержит SystemStatusCard с мониторингом всех компонентов (API, PostgreSQL, ноды, WebSocket). Выделенная страница — дублирование |
| Управление тарифными планами | Панель предназначена для администраторов, не для клиентов. Управление пользователями (лимиты, сроки, HWID) уже реализовано |
| Система плагинов | Сторонний код, sandbox, маркетплейс — overkill. Автоматизации (Фаза 6) + внешний API (Фаза 15) закрывают эту потребность |
| Глубокий мониторинг серверов | Fleet + Node Agent v2 покрывают базовые метрики. Для глубокого мониторинга лучше Prometheus + Grafana |

---

*Последнее обновление: Февраль 2026*
