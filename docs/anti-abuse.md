# Anti-Abuse система: техническая документация

Система Anti-Abuse обнаруживает злоупотребления аккаунтами (шаринг) на основе многофакторного анализа подключений.

---

## Архитектура

```
Node Agent (на ноде)
    │  Читает access.log Xray
    │  POST /api/v1/connections/batch
    ▼
Collector API (в Admin Bot)
    │  Валидация, запись в user_connections
    ▼
IntelligentViolationDetector
    ├── TemporalAnalyzer      (25%) — временные паттерны смены IP
    ├── GeoAnalyzer            (25%) — географическое распределение
    ├── ASNAnalyzer            (15%) — тип провайдера
    ├── UserProfileAnalyzer    (20%) — отклонение от 30-дневного профиля
    └── DeviceFingerprintAnalyzer (15%) — OS и VPN-клиенты
    ▼
Scoring → Action (уведомление / блокировка)
```

## Пороги скоринга

| Скор     | Действие          |
|----------|--------------------|
| < 30     | Нет действия       |
| 30–50    | Мониторинг         |
| 50–65    | Предупреждение     |
| 65–80    | Soft block (лимит) |
| 80–90    | Временная блокировка |
| 90+      | Жёсткая блокировка + ручная проверка |

Все пороги и веса настраиваются через динамические настройки бота (Telegram / веб-панель).

---

## База данных ASN по РФ

Локальная база ASN для точного определения провайдера и типа подключения российских IP.

### Таблица `asn_russia`

| Поле | Описание |
|------|----------|
| `asn` | Номер ASN (первичный ключ) |
| `org_name` / `org_name_en` | Название организации |
| `provider_type` | Тип провайдера (см. ниже) |
| `region`, `city` | Местоположение |
| `ip_ranges` | IP диапазоны (JSON) |
| `is_active` | Активен ли |

### Синхронизация

```bash
# Полная синхронизация (несколько часов)
python scripts/sync_asn_database.py --full

# Тестовая (первые 100 ASN)
python scripts/sync_asn_database.py --limit 100
```

Рекомендуется обновлять раз в неделю (cron):
```bash
0 3 * * 0 cd /path/to/remnawave-admin && python scripts/sync_asn_database.py --full
```

Источники данных: [RIPE Database REST API](https://rest.db.ripe.net), [RIPE Stat API](https://stat.ripe.net).

### Использование

- **GeoIP Service** (`src/services/geoip.py`) — при геолокации российских IP проверяет локальную базу ASN.
- **ASN Analyzer** (`src/services/violation_detector.py`) — использует тип провайдера для скоринга.

---

## Классификация типов провайдеров

| Тип | Описание | Модификатор | Примеры |
|-----|----------|-------------|---------|
| `mobile` | Мобильные пулы (CGNAT, LTE) | ×0.3 | CGNAT пулы, LTE сети |
| `mobile_isp` | Сети мобильных операторов | ×0.5 | МТС, Мегафон, Билайн, Теле2, Yota |
| `fixed` | Проводной ШПД (DSL, GPON) | ×0.8 | Домашний интернет, FTTH |
| `isp` | Крупные провайдеры | ×1.0 | Ростелеком, ER-Telecom, ТТК |
| `regional_isp` | Региональные ISP | ×1.0 | Городские сети |
| `business` | Корпоративные сети | ×1.2 | Яндекс, Mail.ru |
| `hosting` | Хостинг-провайдеры | ×1.5 | Selectel, Timeweb, Beget |
| `infrastructure` | Магистральная инфраструктура | ×1.3 | Транзитные сети |
| `vpn` | VPN/Proxy сервисы | ×1.8 | VPN, анонимайзеры |

### Как работают модификаторы

Модификатор умножается на итоговый скор нарушения. Мобильные операторы (×0.3–0.5) снижают скор, т.к. частая смена IP для них нормальна. Хостинг и VPN (×1.5–1.8) повышают скор.

**Дополнительные правила:**
- Хостинг/датацентры в активных подключениях: +25 к скору
- VPN: +15 к скору
- Корпоративные сети: +10 к скору
- \>70% подключений через подозрительные типы: +20 к скору
- \>50% подключений через подозрительные типы: +10 к скору

### Классификация

Тип определяется автоматически по ключевым словам в названии организации из RIPE Database. Приоритет: локальная база ASN → эвристика по названию.

---

## API методы DatabaseService

- `get_asn_record(asn)` — запись ASN по номеру
- `get_asn_by_org_name(org_name)` — поиск по названию организации
- `get_asn_by_provider_type(provider_type)` — список ASN по типу
- `save_asn_record(asn_record)` — сохранить/обновить запись
