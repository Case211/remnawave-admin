# План интеграции remnawave-bedolaga-telegram-bot в remnawave-admin

## Анализ проектов

### remnawave-admin (текущий проект)
- **Фокус**: Администрирование, мониторинг, anti-abuse
- **Пользователи**: Админы
- **Стек**: Python/aiogram + FastAPI + React/TS + AsyncPG (raw SQL)
- **Есть**: Детекция нарушений (5 анализаторов), мониторинг нод, аналитика трафика, RBAC, аудит, веб-терминал, бэкапы
- **Нет**: Платежей, тикетов поддержки, реферальной системы, промо-кодов, клиентского MiniApp

### bedolaga-bot (внешний проект)
- **Фокус**: Продажа подписок, клиентский self-service
- **Пользователи**: Конечные клиенты
- **Стек**: Python/aiogram + FastAPI + SQLAlchemy ORM + Redis
- **Есть**: 11 платёжных провайдеров, подписки, промо-коды, рефералы, тикеты поддержки, MiniApp, маркетинг, аналитика продаж
- **Нет**: Anti-abuse, мониторинга нод, RBAC, веб-панели для админа

### Общее
- Оба работают с Remnawave Panel API (пользователи, ноды, хосты)
- Оба используют Python + aiogram + FastAPI + PostgreSQL
- Оба используют Docker для деплоя

---

## Стратегия интеграции: Микросервисная архитектура с общим UI

Предлагаю **НЕ** мержить код Bedolaga в монорепо, а выстроить связку:

```
┌─────────────────────────────────────────────────────────┐
│                    Docker Compose                        │
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ remnawave-   │  │  bedolaga-   │  │  remnawave-  │  │
│  │ admin bot    │  │  bot         │  │  panel       │  │
│  │ (admin TG)   │  │ (client TG)  │  │  (VPN mgmt)  │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                 │                  │          │
│  ┌──────┴─────────────────┴──────────────────┘          │
│  │                                                      │
│  │  ┌──────────────┐      ┌──────────────┐             │
│  │  │ web-backend  │◄────►│ web-frontend  │             │
│  │  │ (FastAPI)    │      │ (React SPA)   │             │
│  │  │ unified API  │      │ unified UI    │             │
│  │  └──────┬───────┘      └──────────────┘             │
│  │         │                                            │
│  │  ┌──────┴───────┐  ┌──────────────┐                 │
│  │  │  PostgreSQL   │  │    Redis     │                 │
│  │  │  (shared DB)  │  │  (sessions)  │                 │
│  │  └──────────────┘  └──────────────┘                 │
│  │                                                      │
│  └──────────────────────────────────────────────────────┘
└─────────────────────────────────────────────────────────┘
```

**Ключевая идея**: Bedolaga-bot остаётся отдельным сервисом (свой контейнер), но:
1. Работает с той же БД PostgreSQL (отдельная схема `bedolaga`)
2. Web-backend получает новые эндпоинты для чтения данных Bedolaga
3. Web-frontend получает новые страницы для управления продажами
4. Redis используется совместно для кэширования и событий

---

## Фазы реализации

### Фаза 1: Инфраструктура и совместный деплой

**Цель**: Bedolaga-bot запускается рядом с remnawave-admin в одном Docker Compose

#### 1.1 Docker Compose — добавление Bedolaga-сервисов
- Добавить `bedolaga-bot` сервис в `docker-compose.yml` (profile: `sales`)
- Добавить `redis` сервис (если ещё нет)
- Настроить shared network между всеми сервисами
- Прокинуть переменные окружения для Bedolaga

#### 1.2 Общая база данных
- Bedolaga использует отдельную схему `bedolaga` в той же PostgreSQL
- Создать read-only пользователя для web-backend для чтения данных Bedolaga
- Написать миграции (Alembic) для создания view-таблиц / материализованных представлений

#### 1.3 Конфигурация
- Добавить новые переменные в `.env.example`:
  - `BEDOLAGA_ENABLED=true`
  - `BEDOLAGA_DB_SCHEMA=bedolaga`
  - `BEDOLAGA_BOT_TOKEN=...`
  - Настройки платёжных провайдеров

---

### Фаза 2: Чтение данных Bedolaga из Web Backend

**Цель**: Web-backend умеет читать данные из схемы Bedolaga

#### 2.1 Database Layer — модуль `shared/bedolaga_db.py`
Новый модуль для read-only доступа к таблицам Bedolaga:

```python
# Основные операции:
- get_subscriptions(filters) -> List[Subscription]
- get_subscription_by_user(user_uuid) -> Subscription
- get_transactions(filters) -> List[Transaction]
- get_transaction_stats(period) -> TransactionStats
- get_tickets(filters) -> List[Ticket]
- get_ticket_messages(ticket_id) -> List[Message]
- get_promos(filters) -> List[Promo]
- get_referral_stats() -> ReferralStats
- get_revenue_analytics(period) -> RevenueAnalytics
```

#### 2.2 API Endpoints — `web/backend/api/v2/sales.py`
Новый роутер для данных о продажах:

```
GET  /api/v2/sales/subscriptions          — список подписок с фильтрами
GET  /api/v2/sales/subscriptions/{id}     — детали подписки
GET  /api/v2/sales/transactions           — история транзакций
GET  /api/v2/sales/transactions/stats     — статистика по платежам
GET  /api/v2/sales/revenue                — аналитика доходов
GET  /api/v2/sales/promos                 — промо-коды
GET  /api/v2/sales/referrals              — реферальная статистика
```

#### 2.3 API Endpoints — `web/backend/api/v2/support.py`
Роутер для тикетов поддержки:

```
GET  /api/v2/support/tickets              — список тикетов
GET  /api/v2/support/tickets/{id}         — тикет с сообщениями
PUT  /api/v2/support/tickets/{id}/assign  — назначить на админа
PUT  /api/v2/support/tickets/{id}/close   — закрыть тикет
POST /api/v2/support/tickets/{id}/reply   — ответить из веб-панели
GET  /api/v2/support/stats                — статистика поддержки
```

#### 2.4 Pydantic-схемы — `web/backend/schemas/sales.py`, `schemas/support.py`
Типизированные модели для всех новых эндпоинтов.

#### 2.5 RBAC — новые ресурсы
Добавить в систему прав:
- `sales` → actions: `view`, `edit`, `delete`
- `support` → actions: `view`, `create`, `edit`, `delete`, `assign`
- `promos` → actions: `view`, `create`, `edit`, `delete`
- `referrals` → actions: `view`

---

### Фаза 3: Web Frontend — новые страницы

**Цель**: Админ видит продажи, тикеты, промо в веб-панели

#### 3.1 Страница «Продажи» (`/sales`)
- Таблица подписок с фильтрами (статус, период, тариф)
- Графики: доход за период, конверсия, средний чек
- Разбивка по платёжным провайдерам
- Клик по подписке → детали + связанный пользователь

#### 3.2 Страница «Транзакции» (`/transactions`)
- История всех платежей с фильтрами
- Статистика: дневной/недельный/месячный доход
- Экспорт в CSV

#### 3.3 Страница «Поддержка» (`/support`)
- Список тикетов (открытые/закрытые/в работе)
- Чат-интерфейс для тикета (сообщения пользователя + ответы админа)
- Назначение на конкретного админа
- SLA-метрики

#### 3.4 Страница «Промо» (`/promos`)
- Список промо-кодов с использованием
- Создание/редактирование промо (если write-доступ к БД Bedolaga)
- Статистика эффективности

#### 3.5 Страница «Рефералы» (`/referrals`)
- Топ рефереров
- Граф рефералов
- Статистика конверсии реферальных ссылок

#### 3.6 Обновление Dashboard
- Добавить виджеты: доход за сегодня, активные подписки, открытые тикеты
- Добавить графики конверсии и продаж

#### 3.7 Обновление страницы Users
- В карточке пользователя показать:
  - Его подписки из Bedolaga
  - Историю платежей
  - Тикеты поддержки
  - Реферальные связи
  - Рядом с данными anti-abuse из текущей системы

---

### Фаза 4: Межсервисное взаимодействие (события)

**Цель**: Bedolaga и admin реагируют на события друг друга

#### 4.1 Event Bus через Redis Pub/Sub
Канал `remnawave:events`:

```python
# События от Bedolaga → admin:
- "subscription.created"   → обновить dashboard
- "payment.completed"      → обновить аналитику
- "ticket.created"         → уведомить админа
- "user.registered"        → добавить в мониторинг

# События от admin → Bedolaga:
- "violation.detected"     → предупредить пользователя через бот
- "user.blocked"           → уведомить через бот
- "node.down"              → включить maintenance в Bedolaga
```

#### 4.2 Webhook-интеграция
- Bedolaga шлёт webhook на `web-backend/api/v2/webhooks/bedolaga` при ключевых событиях
- Web-backend шлёт webhook на Bedolaga при обнаружении нарушений

#### 4.3 Уведомления
- Новые тикеты → Telegram-уведомление админам через admin-бот
- Нарушения → сообщение пользователю через Bedolaga-бот
- Платежи → уведомление в admin-бот

---

### Фаза 5: Расширенная аналитика

**Цель**: Объединённая аналитика из обоих источников

#### 5.1 Бизнес-метрики
- LTV пользователя (доход + срок жизни подписки)
- Корреляция нарушений и оттока
- Конверсия trial → платная подписка
- ROI промо-кампаний

#### 5.2 Единый профиль пользователя
- Объединить данные: подписки + трафик + нарушения + платежи + тикеты + устройства
- Scoring: риск (anti-abuse) + ценность (LTV) = приоритет действий
- Рекомендации: автоматические предложения для удержания ценных клиентов

#### 5.3 Отчёты
- Автоматические ежедневные/недельные отчёты с бизнес-метриками
- Экспорт в PDF/CSV
- Отправка в Telegram-группу админов

---

## Приоритеты и порядок реализации

| # | Фаза | Зависимости | Ценность |
|---|-------|------------|----------|
| 1 | Инфраструктура (Docker, DB) | — | Базовая, без неё ничего не работает |
| 2 | Чтение данных (backend API) | Фаза 1 | Высокая — даёт доступ к данным |
| 3 | UI страницы (frontend) | Фаза 2 | Высокая — видимый результат для админа |
| 4 | Межсервисные события | Фаза 1 | Средняя — автоматизация |
| 5 | Расширенная аналитика | Фазы 2-4 | Средняя — долгосрочная ценность |

---

## Альтернативные подходы

### Вариант A: Полный мерж (НЕ рекомендуется)
Перенести весь код Bedolaga внутрь монорепо.
- ❌ Огромный объём работы
- ❌ Невозможно получать обновления от Bedolaga-DEV
- ❌ Разный ORM (AsyncPG vs SQLAlchemy) — конфликты

### Вариант B: Только API-bridge (проще, но ограниченнее)
Bedolaga как чёрный ящик, web-backend ходит к Bedolaga API.
- ✅ Минимум изменений
- ❌ Зависимость от Bedolaga API (если он изменится — всё сломается)
- ❌ Ограниченные возможности аналитики (нет прямого доступа к данным)

### Вариант C: Микросервисы + shared DB (РЕКОМЕНДУЕТСЯ) ← выбранный
- ✅ Bedolaga обновляется независимо
- ✅ Прямой доступ к данным для аналитики
- ✅ Единый UI для админа
- ✅ Межсервисная коммуникация через Redis
- ⚠️ Нужно следить за совместимостью схемы БД Bedolaga при обновлениях

---

## Риски и митигация

| Риск | Вероятность | Митигация |
|------|------------|-----------|
| Bedolaga меняет схему БД | Высокая | Использовать view-слой / материализованные представления, тесты совместимости |
| Конфликт портов/ресурсов | Низкая | Docker networks + уникальные порты |
| Разные версии Python/зависимостей | Средняя | Отдельные контейнеры, изоляция |
| Гонки при записи в общую БД | Средняя | admin читает read-only, пишет только Bedolaga |
| Redis downtime | Низкая | Graceful degradation, fallback на прямые запросы |

---

## Технические решения

### Связка пользователей
Bedolaga хранит `telegram_id` пользователя. remnawave-admin тоже хранит `telegram_id` и `uuid` из Panel.
**Связка**: через `telegram_id` или `remnawave_uuid` (username в Panel).

### Миграции
- Bedolaga управляет своей схемой (свои миграции)
- remnawave-admin создаёт только READ-VIEW поверх схемы Bedolaga
- Тесты совместимости при обновлении Bedolaga

### Feature Flag
Вся интеграция за `BEDOLAGA_ENABLED=true`:
- Backend: условная регистрация роутеров
- Frontend: условный рендер пунктов меню и страниц
- Если выключено — система работает как раньше
