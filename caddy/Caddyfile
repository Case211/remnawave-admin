# Remnawave Admin - Caddy Configuration
# Caddy automatically manages HTTPS certificates via Let's Encrypt

# Global options
{
    # Email for Let's Encrypt notifications
    email admin@example.com

    # Uncomment for staging certificates (testing)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # Admin API (disabled for security)
    admin off
}

# Development configuration (HTTP only)
# Use: caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
:80 {
    # API requests
    handle /api/* {
        reverse_proxy web-backend:8081 {
            # Health checks
            health_uri /api/v2/health
            health_interval 30s

            # Headers
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # WebSocket
    handle /api/v2/ws {
        reverse_proxy web-backend:8081 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
        }
    }

    # Frontend
    handle {
        reverse_proxy web-frontend:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
        }
    }

    # Logging
    log {
        output stdout
        format console
        level INFO
    }
}

# Production configuration (HTTPS with auto-certificates)
# Replace 'admin.example.com' with your actual domain
# Uncomment this block for production use

# admin.example.com {
#     # Security headers
#     header {
#         X-Frame-Options "SAMEORIGIN"
#         X-Content-Type-Options "nosniff"
#         X-XSS-Protection "1; mode=block"
#         Referrer-Policy "strict-origin-when-cross-origin"
#         Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#         -Server
#     }
#
#     # Rate limiting for auth endpoints
#     @auth {
#         path /api/v2/auth/*
#     }
#     route @auth {
#         rate_limit {
#             zone auth_zone {
#                 key {remote_host}
#                 events 5
#                 window 60s
#             }
#         }
#         reverse_proxy web-backend:8081
#     }
#
#     # API requests
#     handle /api/* {
#         reverse_proxy web-backend:8081 {
#             health_uri /api/v2/health
#             health_interval 30s
#
#             header_up Host {host}
#             header_up X-Real-IP {remote_host}
#             header_up X-Forwarded-For {remote_host}
#             header_up X-Forwarded-Proto {scheme}
#         }
#     }
#
#     # WebSocket
#     handle /api/v2/ws {
#         reverse_proxy web-backend:8081 {
#             header_up Host {host}
#             header_up X-Real-IP {remote_host}
#             header_up X-Forwarded-For {remote_host}
#         }
#     }
#
#     # Frontend (static files in production)
#     handle {
#         reverse_proxy web-frontend:80 {
#             header_up Host {host}
#             header_up X-Real-IP {remote_host}
#             header_up X-Forwarded-For {remote_host}
#         }
#     }
#
#     # Compression
#     encode gzip zstd
#
#     # Logging
#     log {
#         output file /var/log/caddy/access.log {
#             roll_size 10mb
#             roll_keep 10
#         }
#         format json
#     }
# }
